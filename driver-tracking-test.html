<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØªØ¨Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ - GPS Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="ØªØ·Ø¨ÙŠÙ‚ ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ØªØªØ¨Ø¹ GPS">
    <link rel="manifest" href="/driver-manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: right;
        }
        
        .info p {
            margin: 10px 0;
            color: #333;
            font-size: 16px;
        }
        
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .status.active {
            background: #d4edda;
            color: #155724;
        }
        
        .status.inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        #debug {
            display: none; /* Ù…Ø®ÙÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚ */
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: right;
            font-size: 12px;
            color: #856404;
        }
        
        .install-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 20px 0;
            display: none;
            width: 100%;
        }
        
        .install-btn:hover {
            background: #218838;
        }
        
        .pwa-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: right;
            font-size: 14px;
            color: #004085;
            border-right: 4px solid #007bff;
        }
        
        .wake-lock-btn {
            background: #ffc107;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0;
            width: 100%;
        }
        
        .wake-lock-btn:hover {
            background: #e0a800;
        }
        
        .wake-lock-btn.active {
            background: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš• Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h1>
        
        <div class="info">
            <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="status active" id="status">Ù†Ø´Ø·</span></p>
            <p><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> <span id="time"></span></p>
            <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="date"></span></p>
        </div>
        
        <!-- PWA Install Button -->
        <button id="installBtn" class="install-btn">
            ğŸ“¥ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        </button>
        
        <!-- PWA Info -->
        <div class="pwa-info" id="pwaInfo" style="display: none;">
            <p><strong>ğŸ“± ØªØ·Ø¨ÙŠÙ‚ ÙˆÙŠØ¨ Ù…ØªÙ‚Ø¯Ù… (PWA)</strong></p>
            <p>ÙŠÙ…ÙƒÙ†Ùƒ ØªØ«Ø¨ÙŠØª Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù‡Ø§ØªÙ Ù„ÙŠØ¹Ù…Ù„ Ù…Ø«Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ø¯ÙŠ!</p>
        </div>
        
        <!-- Wake Lock Button -->
        <button id="wakeLockBtn" class="wake-lock-btn">
            ğŸ”’ Ù…Ù†Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ù† Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        </button>
        
        <p style="color: #666; margin-top: 20px;">
            Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ…Ø§Ù‹ Ù…ÙˆÙÙ‚Ø§Ù‹! ğŸŒŸ
        </p>
        
        <!-- Debug info (hidden from driver) -->
        <div id="debug">
            <p><strong>Debug Info:</strong></p>
            <p id="debugInfo">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB8Q9CYIWXPmTdiz3vPiLlPYFxiJu0vE_g",
            authDomain: "taxi-management-system-d8210.firebaseapp.com",
            projectId: "taxi-management-system-d8210",
            storageBucket: "taxi-management-system-d8210.firebasestorage.app",
            messagingSenderId: "720874424166",
            appId: "1:720874424166:web:25f9c6d126e792b2e5eaa7",
            measurementId: "G-GY8820W410"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Driver ID (ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØ¹Ù„ÙŠØŒ Ø³ÙŠØ£ØªÙŠ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)
        const driverId = 'TEST_DRIVER_001';
        
        // Update time display
        function updateTime() {
            const now = new Date();
            document.getElementById('time').textContent = now.toLocaleTimeString('ar-SA');
            document.getElementById('date').textContent = now.toLocaleDateString('ar-SA');
        }
        updateTime();
        setInterval(updateTime, 1000);

        // Track location
        let trackingActive = false;
        let watchId = null;

        async function sendLocation(position) {
            const locationData = {
                driverId: driverId,
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                speed: position.coords.speed || 0,
                heading: position.coords.heading || 0,
                timestamp: serverTimestamp(),
                localTime: new Date().toISOString()
            };

            try {
                // Save to Firestore
                await setDoc(doc(db, 'driverLocations', driverId), locationData);
                
                // Debug info (hidden)
                const debugInfo = `
                    âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹<br>
                    ğŸ“ Lat: ${position.coords.latitude.toFixed(6)}<br>
                    ğŸ“ Lng: ${position.coords.longitude.toFixed(6)}<br>
                    ğŸ¯ Accuracy: ${position.coords.accuracy.toFixed(0)}m<br>
                    â° ${new Date().toLocaleTimeString('ar-SA')}
                `;
                document.getElementById('debugInfo').innerHTML = debugInfo;
                
                console.log('Location sent:', locationData);
            } catch (error) {
                console.error('Error sending location:', error);
                document.getElementById('debugInfo').innerHTML = `âŒ Ø®Ø·Ø£: ${error.message}`;
            }
        }

        function handleLocationError(error) {
            console.error('Location error:', error);
            document.getElementById('status').textContent = 'ØºÙŠØ± Ù†Ø´Ø·';
            document.getElementById('status').className = 'status inactive';
            
            let errorMsg = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                    break;
                default:
                    errorMsg = 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            }
            
            document.getElementById('debugInfo').innerHTML = `âŒ ${errorMsg}`;
        }

        // Start tracking automatically
        if ('geolocation' in navigator) {
            // Request permission and start tracking
            watchId = navigator.geolocation.watchPosition(
                sendLocation,
                handleLocationError,
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
            
            trackingActive = true;
            console.log('Tracking started automatically');
            
            // Also send location every 10 seconds
            setInterval(() => {
                navigator.geolocation.getCurrentPosition(sendLocation, handleLocationError);
            }, 10000);
        } else {
            alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹');
            document.getElementById('status').textContent = 'ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…';
            document.getElementById('status').className = 'status inactive';
        }

        // Show debug info if URL contains ?debug=true
        if (window.location.search.includes('debug=true')) {
            document.getElementById('debug').style.display = 'block';
        }
        
        // ==================== PWA Features ====================
        
        // 1. Service Worker Registration
        let deferredPrompt;
        let wakeLock = null;
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/driver-sw.js');
                    console.log('Service Worker registered:', registration);
                    
                    // Show PWA info
                    document.getElementById('pwaInfo').style.display = 'block';
                    
                    // Listen for updates
                    registration.addEventListener('updatefound', () => {
                        console.log('Service Worker update found');
                    });
                    
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                }
            });
        }
        
        // 2. Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('beforeinstallprompt event fired');
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button
            document.getElementById('installBtn').style.display = 'block';
        });
        
        document.getElementById('installBtn').addEventListener('click', async () => {
            if (!deferredPrompt) {
                alert('Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø«Ø¨Øª Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„ØªØ«Ø¨ÙŠØª');
                return;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log('Install prompt outcome:', outcome);
            
            if (outcome === 'accepted') {
                console.log('User accepted the install prompt');
                document.getElementById('installBtn').style.display = 'none';
            }
            
            deferredPrompt = null;
        });
        
        // 3. App Installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            document.getElementById('installBtn').style.display = 'none';
            alert('âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!');
        });
        
        // 4. Wake Lock API (prevent screen from sleeping)
        const wakeLockBtn = document.getElementById('wakeLockBtn');
        
        wakeLockBtn.addEventListener('click', async () => {
            if (!('wakeLock' in navigator)) {
                alert('âš ï¸ Ù…ØªØµÙ„Ø­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Wake Lock API');
                return;
            }
            
            try {
                if (wakeLock !== null) {
                    // Release wake lock
                    await wakeLock.release();
                    wakeLock = null;
                    wakeLockBtn.textContent = 'ğŸ”’ Ù…Ù†Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ù† Ø§Ù„Ø¥ØºÙ„Ø§Ù‚';
                    wakeLockBtn.classList.remove('active');
                    console.log('Wake Lock released');
                } else {
                    // Request wake lock
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLockBtn.textContent = 'âœ… Ø§Ù„Ø´Ø§Ø´Ø© Ù…ÙØ¹Ù„Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹';
                    wakeLockBtn.classList.add('active');
                    console.log('Wake Lock acquired');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock was released');
                    });
                }
            } catch (err) {
                console.error('Wake Lock error:', err);
                alert('âš ï¸ Ø®Ø·Ø£: ' + err.message);
            }
        });
        
        // Re-acquire wake lock when page becomes visible
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock re-acquired');
                } catch (err) {
                    console.error('Wake Lock re-acquire error:', err);
                }
            }
        });
        
        // 5. Background Sync (when supported)
        if ('serviceWorker' in navigator && 'sync' in navigator.serviceWorker) {
            console.log('Background Sync is supported');
            
            // Register sync when going offline
            window.addEventListener('offline', async () => {
                console.log('Going offline - registering sync');
                const registration = await navigator.serviceWorker.ready;
                await registration.sync.register('sync-location');
            });
        }
        
        // 6. Periodic Background Sync (experimental)
        if ('serviceWorker' in navigator && 'periodicSync' in navigator.serviceWorker) {
            console.log('Periodic Background Sync is supported');
            
            navigator.serviceWorker.ready.then(async (registration) => {
                try {
                    await registration.periodicSync.register('update-location', {
                        minInterval: 60 * 1000 // 1 minute
                    });
                    console.log('Periodic sync registered');
                } catch (err) {
                    console.error('Periodic sync registration failed:', err);
                }
            });
        }
        
        // 7. Listen for messages from Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                console.log('Message from Service Worker:', event.data);
                
                if (event.data.type === 'UPDATE_LOCATION') {
                    // Trigger location update
                    navigator.geolocation.getCurrentPosition(sendLocation, handleLocationError);
                }
            });
        }
        
        // 8. Battery Status (optional - to warn user)
        if ('getBattery' in navigator) {
            navigator.getBattery().then((battery) => {
                console.log('Battery level:', (battery.level * 100) + '%');
                console.log('Battery charging:', battery.charging);
                
                battery.addEventListener('levelchange', () => {
                    if (battery.level < 0.2 && !battery.charging) {
                        console.warn('Low battery!');
                    }
                });
            });
        }
        
        console.log('PWA features initialized');
        console.log('Service Worker support:', 'serviceWorker' in navigator);
        console.log('Wake Lock support:', 'wakeLock' in navigator);
        console.log('Background Sync support:', 'serviceWorker' in navigator && 'sync' in navigator.serviceWorker);
        console.log('Periodic Sync support:', 'serviceWorker' in navigator && 'periodicSync' in navigator.serviceWorker);
    </script>
</body>
</html>

