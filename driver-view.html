<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بيانات السائق - نظام إدارة التاكسي</title>
    <link rel="stylesheet" href="unified-design-system.css">
    <style>
        .driver-info {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .info-section {
            margin-bottom: 25px;
        }
        
        .info-section h3 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-right: 4px solid #3498db;
        }
        
        .info-label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .info-value {
            color: #34495e;
        }
        
        .amount {
            font-weight: bold;
        }
        
        .positive {
            color: #27ae60;
        }
        
        .negative {
            color: #e74c3c;
        }
        
        .zero {
            color: #7f8c8d;
        }
        
        .status-good {
            color: #27ae60;
            background: #d5f4e6;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .status-warning {
            color: #f39c12;
            background: #fef9e7;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .status-danger {
            color: #e74c3c;
            background: #fadbd8;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .maintenance-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn-update {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-update:hover {
            background: #2980b9;
        }
        
        .btn-logout {
            background: #e74c3c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .btn-logout:hover {
            background: #c0392b;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }
        
        .error {
            background: #fadbd8;
            color: #e74c3c;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .success {
            background: #d5f4e6;
            color: #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚗 بيانات السائق</h1>
            <button class="btn-logout" onclick="logout()">تسجيل الخروج</button>
        </div>

        <div id="loadingDiv" class="loading">
            <p>جاري تحميل البيانات...</p>
        </div>

        <div id="errorDiv" class="error" style="display: none;">
            <p id="errorMessage"></p>
        </div>

        <div id="driverDataDiv" style="display: none;">
            <!-- البيانات الأساسية -->
            <div class="driver-info">
                <div class="info-section">
                    <h3>📋 البيانات الأساسية</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">الاسم:</span>
                            <span class="info-value" id="driverName">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">رقم الهاتف:</span>
                            <span class="info-value" id="driverPhone">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">الجنسية:</span>
                            <span class="info-value" id="driverNationality">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">العنوان:</span>
                            <span class="info-value" id="driverAddress">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">السيارة المخصصة:</span>
                            <span class="info-value" id="assignedCar">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">تاريخ بداية العقد:</span>
                            <span class="info-value" id="contractStart">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- الحالة المالية -->
            <div class="driver-info">
                <div class="info-section">
                    <h3>💰 الحالة المالية</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">الأجرة اليومية:</span>
                            <span class="info-value amount" id="dailyWage">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">آخر دفعة:</span>
                            <span class="info-value" id="lastPayment">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">سداد حتى تاريخ:</span>
                            <span class="info-value" id="paidUntilDate">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">الأيام المتأخرة:</span>
                            <span class="info-value" id="daysLate">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">المبلغ المتأخر:</span>
                            <span class="info-value amount" id="lateAmount">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">رصيد السائق:</span>
                            <span class="info-value amount" id="driverBalance">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">المخالفات:</span>
                            <span class="info-value amount" id="violations">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">رسوم الإقامة:</span>
                            <span class="info-value amount" id="residencyFees">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">الديون القديمة:</span>
                            <span class="info-value amount" id="oldDebts">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">إجمالي الديون:</span>
                            <span class="info-value amount" id="totalDebt">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">حالة الحساب:</span>
                            <span class="info-value" id="accountStatus">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- معلومات الصيانة -->
            <div class="driver-info">
                <div class="info-section">
                    <h3>🔧 معلومات الصيانة</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">الكيلومترات الحالية:</span>
                            <span class="info-value" id="currentKilometers">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">آخر تغيير زيت:</span>
                            <span class="info-value" id="lastOilChange">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">حالة الزيت:</span>
                            <span class="info-value" id="oilStatus">-</span>
                        </div>
                    </div>
                    
                    <div class="maintenance-form">
                        <h4>تحديث بيانات الصيانة</h4>
                        <div class="form-group">
                            <label for="newKilometers">الكيلومترات الجديدة:</label>
                            <input type="number" id="newKilometers" placeholder="أدخل الكيلومترات الحالية">
                        </div>
                        <div class="form-group">
                            <label for="newOilChangeDate">تاريخ تغيير الزيت:</label>
                            <input type="date" id="newOilChangeDate">
                        </div>
                        <button class="btn-update" onclick="updateMaintenance()">تحديث البيانات</button>
                    </div>
                </div>
            </div>

            <!-- الوثائق -->
            <div class="driver-info">
                <div class="info-section">
                    <h3>📄 الوثائق</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">انتهاء الرخصة:</span>
                            <span class="info-value" id="licenseExpiry">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">انتهاء التصريح:</span>
                            <span class="info-value" id="permitExpiry">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">انتهاء دفتر السيارة:</span>
                            <span class="info-value" id="carRegistrationExpiry">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">انتهاء الإقامة:</span>
                            <span class="info-value" id="residenceExpiry">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">انتهاء جواز السفر:</span>
                            <span class="info-value" id="passportExpiry">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">انتهاء التأمين:</span>
                            <span class="info-value" id="insuranceExpiry">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
            authDomain: "taxi-management-system-d8210.firebaseapp.com",
            projectId: "taxi-management-system-d8210",
            storageBucket: "taxi-management-system-d8210.appspot.com",
            messagingSenderId: "1012226491785",
            appId: "1:1012226491785:web:a6b2e3d0f8c4e5f6g7h8i9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        let currentDriver = null;
        let drivers = [];
        let cars = [];
        let driverPayments = [];

        // Initialize page
        window.addEventListener('load', function() {
            checkLogin();
        });

        // Check if user is logged in
        function checkLogin() {
            const driverId = sessionStorage.getItem('driverLoginId');
            const driverName = sessionStorage.getItem('driverLoginName');
            
            if (!driverId || !driverName) {
                window.location.href = 'driver-login.html';
                return;
            }
            
            loadAllData();
        }

        // Load all required data
        async function loadAllData() {
            try {
                document.getElementById('loadingDiv').style.display = 'block';
                document.getElementById('errorDiv').style.display = 'none';
                document.getElementById('driverDataDiv').style.display = 'none';

                // Load all collections
                await Promise.all([
                    loadDrivers(),
                    loadCars(),
                    loadDriverPayments()
                ]);

                // Find current driver
                const driverId = sessionStorage.getItem('driverLoginId');
                currentDriver = drivers.find(d => d.id === driverId);
                
                if (!currentDriver) {
                    throw new Error('لم يتم العثور على بيانات السائق');
                }

                displayDriverData();
                
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                showError('حدث خطأ في تحميل البيانات: ' + error.message);
            }
        }

        // Load drivers from Firebase
        async function loadDrivers() {
            const querySnapshot = await getDocs(collection(db, 'drivers'));
            drivers = [];
            querySnapshot.forEach((doc) => {
                drivers.push({ id: doc.id, ...doc.data() });
            });
        }

        // Load cars from Firebase
        async function loadCars() {
            const querySnapshot = await getDocs(collection(db, 'cars'));
            cars = [];
            querySnapshot.forEach((doc) => {
                cars.push({ id: doc.id, ...doc.data() });
            });
        }

        // Load driver payments from Firebase
        async function loadDriverPayments() {
            const querySnapshot = await getDocs(collection(db, 'driverPayments'));
            driverPayments = [];
            querySnapshot.forEach((doc) => {
                driverPayments.push({ id: doc.id, ...doc.data() });
            });
        }

        // Parse date function (copied from drivers-overview.html)
        function parseDate(dateValue) {
            if (!dateValue) return new Date();
            
            if (dateValue instanceof Date) {
                return dateValue;
            }
            
            if (typeof dateValue === 'string') {
                // Try different date formats
                const date = new Date(dateValue);
                if (!isNaN(date.getTime())) return date;
                
                // Try ISO format
                const isoDate = new Date(dateValue + 'T00:00:00');
                if (!isNaN(isoDate.getTime())) return isoDate;
            }
            
            return new Date();
        }

        // Format date for display (Gregorian calendar)
        function formatDate(date) {
            const parsedDate = parseDate(date);
            return parsedDate.toLocaleDateString('en-GB', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // Calculate debt by type (copied from drivers-overview.html)
        function calculateDebtByType(driverId, types) {
            let debt = 0;
            
            // Get driver's initial old debts
            const driver = drivers.find(d => d.id === driverId);
            if (driver && types.includes('دين قديم') && driver.oldDebts) {
                debt += parseFloat(driver.oldDebts) || 0;
            }
            
            const payments = driverPayments.filter(payment => 
                payment.driverId === driverId && 
                types.includes(payment.type)
            );

            payments.forEach(payment => {
                const amount = parseFloat(payment.amount) || 0;
                if (payment.type === 'دين قديم') {
                    debt -= amount; // Reduce old debt when paid
                } else if (payment.type.startsWith('دفع')) {
                    debt += amount; // Increase debt
                } else if (payment.type.startsWith('تحصيل')) {
                    debt -= amount; // Reduce debt
                }
            });

            return Math.max(0, debt);
        }

        // Calculate driver balance (copied from drivers-overview.html)
        function calculateDriverBalance(driverId, dailyWage) {
            // Get all daily wage payments for this driver
            const dailyWagePayments = driverPayments.filter(payment => 
                payment.driverId === driverId && 
                payment.type === 'أجرة يومية'
            );

            // Sort payments by date (oldest first)
            dailyWagePayments.sort((a, b) => {
                const dateA = parseDate(a.date);
                const dateB = parseDate(b.date);
                return dateA.getTime() - dateB.getTime();
            });

            let currentBalance = 0;
            let totalDaysPaid = 0;

            // Calculate total days paid
            dailyWagePayments.forEach(payment => {
                const amount = parseFloat(payment.amount) || 0;
                const daysPaid = amount / dailyWage;
                totalDaysPaid += daysPaid;
            });

            // Calculate expected days since contract start
            const driver = drivers.find(d => d.id === driverId);
            const contractStart = parseDate(driver?.contractStartDate || driver?.createdAt);
            const today = new Date();
            const daysSinceStart = Math.floor((today - contractStart) / (1000 * 60 * 60 * 24));

            // Calculate balance
            const excessDays = totalDaysPaid - daysSinceStart;
            currentBalance = excessDays * dailyWage;

            return Math.max(0, currentBalance);
        }

        // Calculate driver stats (copied and modified from drivers-overview.html)
        function calculateDriverStats(driver) {
            const today = new Date();
            const contractStart = parseDate(driver.contractStartDate || driver.createdAt);
            const lastPayment = parseDate(driver.lastPaymentDate || driver.contractStartDate || driver.createdAt);
            
            // Calculate days since contract start
            const daysSinceStart = Math.floor((today - contractStart) / (1000 * 60 * 60 * 24));
            
            // Calculate expected payment (daily wage * days)
            const dailyWage = parseFloat(driver.dailyWage || driver.dailyRent || 0);
            const expectedTotal = daysSinceStart * dailyWage;
            
            // Calculate total paid from driver payments
            const payments = driverPayments.filter(payment => 
                payment.driverId === driver.id && 
                payment.type === 'أجرة يومية'
            );
            const totalPaid = payments.reduce((sum, payment) => sum + parseFloat(payment.amount || 0), 0);
            
            // Calculate debt
            const currentDebt = Math.max(0, expectedTotal - totalPaid);
            
            // Calculate days late
            const paidUntilDate = new Date(lastPayment.getTime() + (totalPaid / dailyWage) * 24 * 60 * 60 * 1000);
            const daysLate = Math.max(0, Math.floor((today - paidUntilDate) / (1000 * 60 * 60 * 24)));
            
            // Calculate late amount
            const lateAmount = daysLate * dailyWage;
            
            // Calculate debt amounts using new system
            const violations = calculateDebtByType(driver.id, ['دفع مخالفة', 'تحصيل مخالفة']);
            const residencyFees = calculateDebtByType(driver.id, ['دفع رسوم إقامة', 'تحصيل رسوم إقامة']);
            const oldDebts = calculateDebtByType(driver.id, ['دين قديم']);
            
            // Calculate driver balance using the new smart system first
            const driverBalance = calculateDriverBalance(driver.id, dailyWage);
            
            // Calculate total debt properly (including all components)
            const totalDriverDebt = Math.max(0, lateAmount + violations + residencyFees + oldDebts - driverBalance);

            return {
                dailyWage,
                contractStart,
                lastPayment,
                paidUntilDate,
                daysLate,
                lateAmount,
                driverBalance,
                violations,
                residencyFees,
                oldDebts,
                totalDebt: totalDriverDebt,
                status: daysLate > 7 ? 'متأخر جداً' : daysLate > 0 ? 'متأخر' : 'منتظم'
            };
        }

        // Get expiry status and color
        function getExpiryStatus(expiryDate) {
            if (!expiryDate) return { status: 'غير محدد', color: '#6c757d', class: 'status-warning' };
            
            const expiry = parseDate(expiryDate);
            const today = new Date();
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return { status: `منتهي منذ ${Math.abs(diffDays)} يوم`, color: '#e74c3c', class: 'status-danger' };
            } else if (diffDays <= 30) {
                return { status: `ينتهي خلال ${diffDays} يوم`, color: '#f39c12', class: 'status-warning' };
            } else {
                return { status: `صالح (${diffDays} يوم متبقي)`, color: '#27ae60', class: 'status-good' };
            }
        }

        // Display driver data
        function displayDriverData() {
            try {
                // Calculate financial stats
                const stats = calculateDriverStats(currentDriver);
                
                // Get car information
                const car = cars?.find(c => c.id === currentDriver.assignedCar);
                const carInfo = car ? `${car.plateNumber} - ${car.model} (${car.year || 'غير محدد'})` : 'غير محدد';
                
                // Basic information
                document.getElementById('driverName').textContent = currentDriver.name || 'غير محدد';
                document.getElementById('driverPhone').textContent = currentDriver.phone || 'غير محدد';
                document.getElementById('driverNationality').textContent = currentDriver.nationality || 'غير محدد';
                document.getElementById('driverAddress').textContent = currentDriver.address || 'غير محدد';
                document.getElementById('assignedCar').textContent = carInfo;
                document.getElementById('contractStart').textContent = formatDate(stats.contractStart);

                // Financial information
                document.getElementById('dailyWage').textContent = `${stats.dailyWage.toFixed(3)} د.ك`;
                document.getElementById('dailyWage').className = 'info-value amount';
                
                document.getElementById('lastPayment').textContent = formatDate(stats.lastPayment);
                document.getElementById('paidUntilDate').textContent = formatDate(stats.paidUntilDate);
                document.getElementById('daysLate').textContent = stats.daysLate;
                
                // Late amount
                const lateAmountEl = document.getElementById('lateAmount');
                lateAmountEl.textContent = `${stats.lateAmount.toFixed(3)} د.ك`;
                lateAmountEl.className = `info-value amount ${stats.lateAmount > 0 ? 'negative' : 'zero'}`;
                
                // Driver balance
                const balanceEl = document.getElementById('driverBalance');
                balanceEl.textContent = `${stats.driverBalance.toFixed(3)} د.ك`;
                balanceEl.className = `info-value amount ${stats.driverBalance > 0 ? 'positive' : 'zero'}`;
                
                // Violations
                const violationsEl = document.getElementById('violations');
                violationsEl.textContent = `${stats.violations.toFixed(3)} د.ك`;
                violationsEl.className = `info-value amount ${stats.violations > 0 ? 'negative' : 'zero'}`;
                
                // Residency fees
                const residencyEl = document.getElementById('residencyFees');
                residencyEl.textContent = `${stats.residencyFees.toFixed(3)} د.ك`;
                residencyEl.className = `info-value amount ${stats.residencyFees > 0 ? 'negative' : 'zero'}`;
                
                // Old debts
                const oldDebtsEl = document.getElementById('oldDebts');
                oldDebtsEl.textContent = `${stats.oldDebts.toFixed(3)} د.ك`;
                oldDebtsEl.className = `info-value amount ${stats.oldDebts > 0 ? 'negative' : 'zero'}`;
                
                // Total debt
                const totalDebtEl = document.getElementById('totalDebt');
                totalDebtEl.textContent = `${stats.totalDebt.toFixed(3)} د.ك`;
                totalDebtEl.className = `info-value amount ${stats.totalDebt > 0 ? 'negative' : 'positive'}`;
                
                // Account status
                const statusEl = document.getElementById('accountStatus');
                statusEl.textContent = stats.status;
                statusEl.className = `info-value ${stats.status === 'منتظم' ? 'status-good' : stats.status === 'متأخر' ? 'status-warning' : 'status-danger'}`;

                // Maintenance information
                document.getElementById('currentKilometers').textContent = currentDriver.currentKilometers || 'غير محدد';
                document.getElementById('lastOilChange').textContent = currentDriver.lastOilChange ? formatDate(currentDriver.lastOilChange) : 'غير محدد';
                
                // Oil status
                const oilStatusEl = document.getElementById('oilStatus');
                if (currentDriver.lastOilChange) {
                    const lastChange = parseDate(currentDriver.lastOilChange);
                    const today = new Date();
                    const daysSinceChange = Math.floor((today - lastChange) / (1000 * 60 * 60 * 24));
                    
                    if (daysSinceChange > 15) {
                        oilStatusEl.textContent = `متأخر (${daysSinceChange} يوم)`;
                        oilStatusEl.className = 'info-value status-danger';
                    } else if (daysSinceChange > 10) {
                        oilStatusEl.textContent = `تحذير (${daysSinceChange} يوم)`;
                        oilStatusEl.className = 'info-value status-warning';
                    } else {
                        oilStatusEl.textContent = `جيد (${daysSinceChange} يوم)`;
                        oilStatusEl.className = 'info-value status-good';
                    }
                } else {
                    oilStatusEl.textContent = 'غير محدد';
                    oilStatusEl.className = 'info-value status-warning';
                }

                // Documents
                const licenseStatus = getExpiryStatus(currentDriver.licenseExpiry);
                const licenseEl = document.getElementById('licenseExpiry');
                licenseEl.textContent = currentDriver.licenseExpiry ? `${formatDate(currentDriver.licenseExpiry)} (${licenseStatus.status})` : 'غير محدد';
                licenseEl.className = `info-value ${licenseStatus.class}`;

                const permitStatus = getExpiryStatus(currentDriver.permitExpiry);
                const permitEl = document.getElementById('permitExpiry');
                permitEl.textContent = currentDriver.permitExpiry ? `${formatDate(currentDriver.permitExpiry)} (${permitStatus.status})` : 'غير محدد';
                permitEl.className = `info-value ${permitStatus.class}`;

                // Car registration (from car data)
                const carRegStatus = getExpiryStatus(car?.registrationExpiry);
                const carRegEl = document.getElementById('carRegistrationExpiry');
                carRegEl.textContent = car?.registrationExpiry ? `${formatDate(car.registrationExpiry)} (${carRegStatus.status})` : 'غير محدد';
                carRegEl.className = `info-value ${carRegStatus.class}`;

                const residenceStatus = getExpiryStatus(currentDriver.residenceExpiry);
                const residenceEl = document.getElementById('residenceExpiry');
                residenceEl.textContent = currentDriver.residenceExpiry ? `${formatDate(currentDriver.residenceExpiry)} (${residenceStatus.status})` : 'غير محدد';
                residenceEl.className = `info-value ${residenceStatus.class}`;

                const passportStatus = getExpiryStatus(currentDriver.passportExpiry);
                const passportEl = document.getElementById('passportExpiry');
                passportEl.textContent = currentDriver.passportExpiry ? `${formatDate(currentDriver.passportExpiry)} (${passportStatus.status})` : 'غير محدد';
                passportEl.className = `info-value ${passportStatus.class}`;

                // Insurance (same as car registration)
                const insuranceEl = document.getElementById('insuranceExpiry');
                insuranceEl.textContent = car?.registrationExpiry ? `${formatDate(car.registrationExpiry)} (${carRegStatus.status})` : 'غير محدد';
                insuranceEl.className = `info-value ${carRegStatus.class}`;

                // Show data and hide loading
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('driverDataDiv').style.display = 'block';
                
            } catch (error) {
                console.error('خطأ في عرض البيانات:', error);
                showError('حدث خطأ في عرض البيانات: ' + error.message);
            }
        }

        // Update maintenance data
        window.updateMaintenance = async function() {
            const newKilometers = document.getElementById('newKilometers').value;
            const newOilChangeDate = document.getElementById('newOilChangeDate').value;
            
            if (!newKilometers && !newOilChangeDate) {
                alert('يرجى إدخال الكيلومترات أو تاريخ تغيير الزيت على الأقل');
                return;
            }
            
            try {
                const updateData = {};
                
                if (newKilometers) {
                    updateData.currentKilometers = parseInt(newKilometers);
                }
                
                if (newOilChangeDate) {
                    updateData.lastOilChange = newOilChangeDate;
                }
                
                // Update in Firebase
                const driverRef = doc(db, 'drivers', currentDriver.id);
                await updateDoc(driverRef, updateData);
                
                // Update local data
                Object.assign(currentDriver, updateData);
                
                // Refresh display
                displayDriverData();
                
                // Clear form
                document.getElementById('newKilometers').value = '';
                document.getElementById('newOilChangeDate').value = '';
                
                // Show success message
                showSuccess('تم تحديث بيانات الصيانة بنجاح');
                
            } catch (error) {
                console.error('خطأ في تحديث البيانات:', error);
                alert('حدث خطأ في تحديث البيانات: ' + error.message);
            }
        };

        // Show error message
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorDiv').style.display = 'block';
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('driverDataDiv').style.display = 'none';
        }

        // Parse date function (copied from drivers-overview.html)
        function parseDate(dateValue) {
            if (!dateValue) return new Date();
            
            if (dateValue instanceof Date) {
                return dateValue;
            }
            
            if (typeof dateValue === 'string') {
                // Try different date formats
                const date = new Date(dateValue);
                if (!isNaN(date.getTime())) return date;
                
                // Try ISO format
                const isoDate = new Date(dateValue + 'T00:00:00');
                if (!isNaN(isoDate.getTime())) return isoDate;
            }
            
            return new Date();
        }

        // Format date for display (Gregorian calendar)
        function formatDate(date) {
            const parsedDate = parseDate(date);
            return parsedDate.toLocaleDateString('en-GB', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // Calculate debt by type (copied from drivers-overview.html)
        function calculateDebtByType(driverId, types) {
            let debt = 0;
            
            // Get driver's initial old debts
            const driver = drivers.find(d => d.id === driverId);
            if (driver && types.includes('دين قديم') && driver.oldDebts) {
                debt += parseFloat(driver.oldDebts) || 0;
            }
            
            const payments = driverPayments.filter(payment => 
                payment.driverId === driverId && 
                types.includes(payment.type)
            );

            payments.forEach(payment => {
                const amount = parseFloat(payment.amount) || 0;
                if (payment.type === 'دين قديم') {
                    debt -= amount; // Reduce old debt when paid
                } else if (payment.type.startsWith('دفع')) {
                    debt += amount; // Increase debt
                } else if (payment.type.startsWith('تحصيل')) {
                    debt -= amount; // Reduce debt
                }
            });

            return Math.max(0, debt);
        }

        // Calculate driver balance (copied from drivers-overview.html)
        function calculateDriverBalance(driverId, dailyWage) {
            // Get all daily wage payments for this driver
            const dailyWagePayments = driverPayments.filter(payment => 
                payment.driverId === driverId && 
                payment.type === 'أجرة يومية'
            );

            // Sort payments by date (oldest first)
            dailyWagePayments.sort((a, b) => {
                const dateA = parseDate(a.date);
                const dateB = parseDate(b.date);
                return dateA.getTime() - dateB.getTime();
            });

            let currentBalance = 0;
            let totalDaysPaid = 0;

            // Calculate total days paid
            dailyWagePayments.forEach(payment => {
                const amount = parseFloat(payment.amount) || 0;
                const daysPaid = amount / dailyWage;
                totalDaysPaid += daysPaid;
            });

            // Calculate expected days since contract start
            const driver = drivers.find(d => d.id === driverId);
            const contractStart = parseDate(driver?.contractStartDate || driver?.createdAt);
            const today = new Date();
            const daysSinceStart = Math.floor((today - contractStart) / (1000 * 60 * 60 * 24));

            // Calculate balance
            const excessDays = totalDaysPaid - daysSinceStart;
            currentBalance = excessDays * dailyWage;

            return Math.max(0, currentBalance);
        }

        // Calculate driver stats (copied and modified from drivers-overview.html)
        function calculateDriverStats(driver) {
            const today = new Date();
            const contractStart = parseDate(driver.contractStartDate || driver.createdAt);
            const lastPayment = parseDate(driver.lastPaymentDate || driver.contractStartDate || driver.createdAt);
            
            // Calculate days since contract start
            const daysSinceStart = Math.floor((today - contractStart) / (1000 * 60 * 60 * 24));
            
            // Calculate expected payment (daily wage * days)
            const dailyWage = parseFloat(driver.dailyWage || driver.dailyRent || 0);
            const expectedTotal = daysSinceStart * dailyWage;
            
            // Calculate total paid from driver payments
            const payments = driverPayments.filter(payment => 
                payment.driverId === driver.id && 
                payment.type === 'أجرة يومية'
            );
            const totalPaid = payments.reduce((sum, payment) => sum + parseFloat(payment.amount || 0), 0);
            
            // Calculate debt
            const currentDebt = Math.max(0, expectedTotal - totalPaid);
            
            // Calculate days late
            const paidUntilDate = new Date(lastPayment.getTime() + (totalPaid / dailyWage) * 24 * 60 * 60 * 1000);
            const daysLate = Math.max(0, Math.floor((today - paidUntilDate) / (1000 * 60 * 60 * 24)));
            
            // Calculate late amount
            const lateAmount = daysLate * dailyWage;
            
            // Calculate debt amounts using new system
            const violations = calculateDebtByType(driver.id, ['دفع مخالفة', 'تحصيل مخالفة']);
            const residencyFees = calculateDebtByType(driver.id, ['دفع رسوم إقامة', 'تحصيل رسوم إقامة']);
            const oldDebts = calculateDebtByType(driver.id, ['دين قديم']);
            
            // Calculate driver balance using the new smart system first
            const driverBalance = calculateDriverBalance(driver.id, dailyWage);
            
            // Calculate total debt properly (including all components)
            const totalDriverDebt = Math.max(0, lateAmount + violations + residencyFees + oldDebts - driverBalance);

            return {
                dailyWage,
                contractStart,
                lastPayment,
                paidUntilDate,
                daysLate,
                lateAmount,
                driverBalance,
                violations,
                residencyFees,
                oldDebts,
                totalDebt: totalDriverDebt,
                status: daysLate > 7 ? 'متأخر جداً' : daysLate > 0 ? 'متأخر' : 'منتظم'
            };
        }

        // Show success message
        function showSuccess(message) {
            // Remove any existing success message
            const existingSuccess = document.querySelector('.success');
            if (existingSuccess) {
                existingSuccess.remove();
            }
            
            // Create and show success message
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(successDiv, container.firstChild);
            
            // Remove after 3 seconds
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Logout function
        window.logout = function() {
            sessionStorage.removeItem('driverLoginId');
            sessionStorage.removeItem('driverLoginName');
            window.location.href = 'driver-login.html';
        };
    </script>
</body>
</html>

