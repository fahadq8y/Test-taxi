<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة شركة التاكسي</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="stylesheet" href="style.css">
    
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="login-icon">🚕</div>
                <h1>نظام إدارة التاكسي</h1>
                <p>إدارة شاملة لشركة التاكسي</p>
            </div>

            <div class="error-message" id="errorMessage"></div>

            <form id="loginForm" class="login-form">
                <div class="input-group">
                    <div class="input-icon">📧</div>
                    <input type="email" id="email" placeholder="البريد الإلكتروني" required>
                </div>

                <div class="input-group">
                    <div class="input-icon">🔒</div>
                    <input type="password" id="password" placeholder="كلمة المرور" required>
                </div>

                <button type="submit" class="login-btn" id="loginBtn">
                    <span>تسجيل الدخول</span>
                    <span class="btn-arrow">→</span>
                </button>
            </form>

            <div class="login-footer">
                <a href="driver-login.html" class="driver-login-link">
                    <span>🚗</span>
                    <span>دخول السائقين</span>
                </a>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>جاري تسجيل الدخول...</p>
        </div>
    </div>

    <div class="install-prompt" id="installPrompt">
        <span>تثبيت التطبيق على جهازك للوصول السريع</span>
        <div>
            <button class="install-btn" id="installBtn">تثبيت</button>
            <button class="close-btn" id="closeInstall">×</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB8Q9CYIWXPmTdiz3vPiLlPYFxiJu0vE_g",
            authDomain: "taxi-management-system-d8210.firebaseapp.com",
            projectId: "taxi-management-system-d8210",
            storageBucket: "taxi-management-system-d8210.firebasestorage.app",
            messagingSenderId: "720874424166",
            appId: "1:720874424166:web:25f9c6d126e792b2e5eaa7",
            measurementId: "G-GY8820W410"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM elements
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const errorMessage = document.getElementById('errorMessage');
        const loading = document.getElementById('loading');

        // Login form handler
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = emailInput.value.trim();
            const password = passwordInput.value;

            if (!email || !password) {
                showError('يرجى إدخال البريد الإلكتروني وكلمة المرور');
                return;
            }

            setLoading(true);
            hideError();

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Get user role from Firestore
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    if (!userData.isActive) {
                        throw new Error('تم تعطيل حسابك. يرجى التواصل مع المدير');
                    }

                    // Store user data in localStorage
                    localStorage.setItem('userRole', userData.role);
                    localStorage.setItem('userName', userData.name);
                    localStorage.setItem('userId', user.uid);

                    // Redirect based on role
                    switch (userData.role) {
                        case 'admin':
                            window.location.href = 'admin-dashboard.html';
                            break;
                        case 'accountant':
                            window.location.href = 'accountant-dashboard.html';
                            break;
                        case 'driver':
                            window.location.href = 'driver-dashboard.html';
                            break;
                        default:
                            throw new Error('نوع المستخدم غير صحيح');
                    }
                } else {
                    throw new Error('بيانات المستخدم غير موجودة');
                }

            } catch (error) {
                console.error('Login error:', error);
                let errorMsg = 'حدث خطأ في تسجيل الدخول';
                
                if (error.code === 'auth/user-not-found') {
                    errorMsg = 'البريد الإلكتروني غير مسجل';
                } else if (error.code === 'auth/wrong-password') {
                    errorMsg = 'كلمة المرور غير صحيحة';
                } else if (error.code === 'auth/invalid-email') {
                    errorMsg = 'البريد الإلكتروني غير صحيح';
                } else if (error.message) {
                    errorMsg = error.message;
                }
                
                showError(errorMsg);
            } finally {
                setLoading(false);
            }
        });

        function setLoading(isLoading) {
            if (isLoading) {
                loginBtn.disabled = true;
                loginBtn.style.display = 'none';
                loading.style.display = 'block';
            } else {
                loginBtn.disabled = false;
                loginBtn.style.display = 'block';
                loading.style.display = 'none';
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        // PWA Install functionality
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        const installBtn = document.getElementById('installBtn');
        const closeInstall = document.getElementById('closeInstall');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPrompt.style.display = 'flex';
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                installPrompt.style.display = 'none';
            }
        });

        closeInstall.addEventListener('click', () => {
            installPrompt.style.display = 'none';
        });

        // Check if user is already logged in
        auth.onAuthStateChanged((user) => {
            if (user) {
                const userRole = localStorage.getItem('userRole');
                if (userRole) {
                    switch (userRole) {
                        case 'admin':
                            window.location.href = 'admin-dashboard.html';
                            break;
                        case 'accountant':
                            window.location.href = 'accountant-dashboard.html';
                            break;
                        case 'driver':
                            window.location.href = 'driver-dashboard.html';
                            break;
                    }
                }
            }
        });
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>

