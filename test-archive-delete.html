<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø°Ù Ø§Ù„Ø£Ø±Ø´ÙŠÙ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #1d4ed8;
        }
        .delete-btn {
            background: #dc3545;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        #output {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .record {
            padding: 10px;
            margin: 10px 0;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù Ù…Ù† archivedDrivers</h1>
        
        <div class="test-section">
            <h3>Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©</h3>
            <button onclick="loadArchivedDrivers()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
            <div id="records"></div>
        </div>

        <div class="test-section">
            <h3>Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø°Ù</h3>
            <p>Ø³ÙŠØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø°Ù Ø³Ø¬Ù„ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ</p>
            <button class="delete-btn" onclick="testDelete()">ğŸ—‘ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø°Ù</button>
        </div>

        <div class="test-section">
            <h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</h3>
            <div id="output">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyB8Q9CYIWXPmTdiz3vPiLlPYFxiJu0vE_g",
            authDomain: "taxi-management-system-d8210.firebaseapp.com",
            projectId: "taxi-management-system-d8210",
            storageBucket: "taxi-management-system-d8210.firebasestorage.app",
            messagingSenderId: "720874424166",
            appId: "1:720874424166:web:25f9c6d126e792b2e5eaa7",
            measurementId: "G-GY8820W410"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let archivedDrivers = [];
        let currentUser = null;

        function log(message) {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString('ar-EG');
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        // Check authentication
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                log('âŒ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (!userDoc.exists()) {
                    log('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    return;
                }
                
                const userData = userDoc.data();
                currentUser = { uid: user.uid, ...userData };
                log(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­: ${userData.name || userData.email}`);
                log(`ğŸ“‹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: ${userData.role}`);
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${error.message}`);
            }
        });

        window.loadArchivedDrivers = async function() {
            try {
                log('ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©...');
                const archivedSnapshot = await getDocs(collection(db, 'archivedDrivers'));
                log(`ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${archivedSnapshot.size}`);
                
                archivedDrivers = [];
                const recordsDiv = document.getElementById('records');
                recordsDiv.innerHTML = '';
                
                archivedSnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    archivedDrivers.push({ id: docSnap.id, ...data });
                    
                    const recordDiv = document.createElement('div');
                    recordDiv.className = 'record';
                    recordDiv.innerHTML = `
                        <strong>ID:</strong> ${docSnap.id}<br>
                        <strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${data.name}<br>
                        <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${data.phone}<br>
                        ${data.restoredAt ? `<strong style="color: red;">âš ï¸ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ:</strong> ${new Date(data.restoredAt.seconds * 1000).toLocaleString('ar-EG')}<br>` : ''}
                        ${data.restoredBy ? `<strong>Ø¨ÙˆØ§Ø³Ø·Ø©:</strong> ${data.restoredBy}<br>` : ''}
                    `;
                    recordsDiv.appendChild(recordDiv);
                    
                    log(`ğŸ“¦ ${docSnap.id}: ${data.name} (${data.phone})`);
                    if (data.restoredAt) {
                        log(`   âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹!`);
                    }
                });
                
                log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${error.message}`);
                log(`   ÙƒÙˆØ¯ Ø§Ù„Ø®Ø·Ø£: ${error.code}`);
            }
        };

        window.testDelete = async function() {
            if (archivedDrivers.length === 0) {
                log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø­Ù…Ù„Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            // Ø§Ø®ØªØ± Ø£ÙˆÙ„ Ø³Ø¬Ù„ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹ (ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ restoredAt)
            const testRecord = archivedDrivers.find(d => d.restoredAt) || archivedDrivers[0];
            
            log('\nğŸ§ª ========== Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø°Ù ==========');
            log(`ğŸ“Œ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±:`);
            log(`   ID: ${testRecord.id}`);
            log(`   Ø§Ù„Ø§Ø³Ù…: ${testRecord.name}`);
            log(`   Ø§Ù„Ù‡Ø§ØªÙ: ${testRecord.phone}`);
            
            if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„:\n${testRecord.name} (${testRecord.phone})\n\nÙ‡Ø°Ø§ Ø§Ø®ØªØ¨Ø§Ø± ÙÙ‚Ø·!`)) {
                log('âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
                return;
            }

            try {
                log('\nğŸ—‘ï¸ Ø§Ù„Ø®Ø·ÙˆØ© 1: Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„...');
                const docRef = doc(db, 'archivedDrivers', testRecord.id);
                
                log(`   ğŸ“ Ø§Ù„Ù…Ø³Ø§Ø±: archivedDrivers/${testRecord.id}`);
                
                await deleteDoc(docRef);
                log('âœ… ØªÙ… ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­!');

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø°Ù
                log('\nğŸ” Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø°Ù...');
                const verifyDoc = await getDoc(docRef);
                
                if (verifyDoc.exists()) {
                    log('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: Ø§Ù„Ø³Ø¬Ù„ Ù…Ø§ Ø²Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹!');
                    log(`   Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©: ${JSON.stringify(verifyDoc.data(), null, 2)}`);
                } else {
                    log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚: Ø§Ù„Ø³Ø¬Ù„ ØªÙ… Ø­Ø°ÙÙ‡ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!');
                }

                log('\nâœ… ========== Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ ==========');
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
                setTimeout(() => {
                    log('\nğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª...');
                    loadArchivedDrivers();
                }, 1000);

            } catch (error) {
                log(`\nâŒ ========== ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ==========`);
                log(`âŒ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£: ${error.name}`);
                log(`âŒ ÙƒÙˆØ¯ Ø§Ù„Ø®Ø·Ø£: ${error.code}`);
                log(`âŒ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£: ${error.message}`);
                log(`âŒ Stack: ${error.stack}`);
                
                if (error.code === 'permission-denied') {
                    log('\nâš ï¸ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø­Ø°Ù Ù…Ù† archivedDrivers');
                    log('   Ø§Ù„Ø­Ù„: ÙŠØ¬Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù† ÙÙŠ Firebase');
                }
            }
        };

        // Make functions available globally
        window.db = db;
        window.auth = auth;
    </script>
</body>
</html>

