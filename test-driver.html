<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš• Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ - Geolocation Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .status-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .status-value.success {
            color: #28a745;
        }

        .status-value.error {
            color: #dc3545;
        }

        .status-value.warning {
            color: #ffc107;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .console-line {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }

        .console-line.info {
            color: #4fc3f7;
        }

        .console-line.success {
            color: #66bb6a;
        }

        .console-line.error {
            color: #ef5350;
            background: rgba(239, 83, 80, 0.1);
        }

        .console-line.warning {
            color: #ffca28;
        }

        .console-timestamp {
            color: #888;
            margin-left: 10px;
        }

        .location-data {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .location-data pre {
            margin: 0;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 5px;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-danger {
            background: #dc3545;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: #333;
        }

        .badge-info {
            background: #17a2b8;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸš• Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ - Geolocation Test</h1>
            <p>Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø± Ù„Ù€ Geolocation API Ø¨Ø¯ÙˆÙ† React Native</p>
            <p style="margin-top: 5px;">
                <span class="badge badge-info">Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø§Ø¦Ù‚: DRV001</span>
                <span class="badge badge-warning" id="watchIdBadge">Watch ID: ØºÙŠØ± Ù†Ø´Ø·</span>
            </p>
        </div>

        <!-- Permission Status -->
        <div class="card">
            <h2>ğŸ“ Ø­Ø§Ù„Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
                    <div class="status-value" id="permissionStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Geolocation API</div>
                    <div class="status-value" id="geoApiStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Ù†ÙˆØ¹ Ø§Ù„Ù…ØªØµÙØ­</div>
                    <div class="status-value" id="browserType">-</div>
                </div>
            </div>
        </div>

        <!-- Tracking Status -->
        <div class="card">
            <h2>ğŸ¯ Ø­Ø§Ù„Ø© Ø§Ù„ØªØªØ¨Ø¹</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">Ø­Ø§Ù„Ø© Ø§Ù„ØªØªØ¨Ø¹</div>
                    <div class="status-value" id="trackingStatus">ØºÙŠØ± Ù†Ø´Ø·</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª</div>
                    <div class="status-value" id="updateCount">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</div>
                    <div class="status-value" id="lastUpdate">-</div>
                </div>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="card">
            <h2>ğŸ® Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <button class="btn btn-success" id="startBtn" onclick="startTracking()">
                â–¶ Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹
            </button>
            <button class="btn btn-danger" id="stopBtn" onclick="stopTracking()" disabled>
                â–  Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹
            </button>
            <button class="btn btn-primary" onclick="getCurrentPosition()">
                ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
            </button>
            <button class="btn btn-info" onclick="clearConsole()">
                ğŸ—‘ï¸ Ù…Ø³Ø­ Console
            </button>
        </div>

        <!-- Location Data -->
        <div class="card">
            <h2>ğŸ“Œ Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹</h2>
            <div class="location-data" id="locationData">
                <p style="color: #999; text-align: center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</p>
            </div>
        </div>

        <!-- Console -->
        <div class="card">
            <h2>ğŸ–¥ï¸ Console (Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«)</h2>
            <div class="console" id="console">
                <div class="console-line info">
                    [INFO] Console Ø¬Ø§Ù‡Ø²... <span class="console-timestamp">${new Date().toLocaleTimeString('ar-SA')}</span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAECsL_kKKSoQv-sSRJhMO8sSXTvuv_Jqo",
            authDomain: "taxi-management-system-d8210.firebaseapp.com",
            projectId: "taxi-management-system-d8210",
            storageBucket: "taxi-management-system-d8210.firebasestorage.app",
            messagingSenderId: "966856802326",
            appId: "1:966856802326:web:e5a9b0f4e5e5e5e5e5e5e5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        const driverId = 'DRV001';
        let watchId = null;
        let updateCount = 0;
        let lastPosition = null;

        // Console functions
        function logToConsole(message, type = 'info') {
            const consoleEl = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.innerHTML = `[${type.toUpperCase()}] ${message} <span class="console-timestamp">${timestamp}</span>`;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
            
            // Also log to browser console
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        window.clearConsole = function() {
            document.getElementById('console').innerHTML = '';
            logToConsole('Console ØªÙ… Ù…Ø³Ø­Ù‡', 'info');
        };

        // Check browser and permissions
        async function checkBrowserAndPermissions() {
            // Check browser type
            const userAgent = navigator.userAgent;
            let browserType = 'Unknown';
            if (userAgent.includes('Chrome')) browserType = 'Chrome';
            else if (userAgent.includes('Safari')) browserType = 'Safari';
            else if (userAgent.includes('Firefox')) browserType = 'Firefox';
            else if (userAgent.includes('Edge')) browserType = 'Edge';
            
            document.getElementById('browserType').textContent = browserType;
            logToConsole(`Ø§Ù„Ù…ØªØµÙØ­: ${browserType}`, 'info');

            // Check Geolocation API
            if ('geolocation' in navigator) {
                document.getElementById('geoApiStatus').textContent = 'âœ“ Ù…ØªÙˆÙØ±';
                document.getElementById('geoApiStatus').className = 'status-value success';
                logToConsole('Geolocation API Ù…ØªÙˆÙØ±', 'success');
            } else {
                document.getElementById('geoApiStatus').textContent = 'âœ— ØºÙŠØ± Ù…ØªÙˆÙØ±';
                document.getElementById('geoApiStatus').className = 'status-value error';
                logToConsole('Geolocation API ØºÙŠØ± Ù…ØªÙˆÙØ±!', 'error');
                return;
            }

            // Check permissions (if supported)
            if ('permissions' in navigator) {
                try {
                    const result = await navigator.permissions.query({ name: 'geolocation' });
                    updatePermissionStatus(result.state);
                    
                    // Listen for permission changes
                    result.addEventListener('change', () => {
                        updatePermissionStatus(result.state);
                    });
                } catch (error) {
                    logToConsole(`ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: ${error.message}`, 'warning');
                    document.getElementById('permissionStatus').textContent = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                }
            } else {
                logToConsole('Permissions API ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­', 'warning');
                document.getElementById('permissionStatus').textContent = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            }
        }

        function updatePermissionStatus(state) {
            const statusEl = document.getElementById('permissionStatus');
            
            if (state === 'granted') {
                statusEl.textContent = 'âœ“ Ù…Ù…Ù†ÙˆØ­Ø©';
                statusEl.className = 'status-value success';
                logToConsole('ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…Ù…Ù†ÙˆØ­Ø©', 'success');
            } else if (state === 'denied') {
                statusEl.textContent = 'âœ— Ù…Ø±ÙÙˆØ¶Ø©';
                statusEl.className = 'status-value error';
                logToConsole('ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…Ø±ÙÙˆØ¶Ø©', 'error');
            } else {
                statusEl.textContent = 'âš  Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
                statusEl.className = 'status-value warning';
                logToConsole('ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', 'warning');
            }
        }

        // Update location data display
        function updateLocationDisplay(position) {
            const data = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                altitude: position.coords.altitude,
                altitudeAccuracy: position.coords.altitudeAccuracy,
                heading: position.coords.heading,
                speed: position.coords.speed,
                timestamp: new Date(position.timestamp).toLocaleString('ar-SA')
            };

            const html = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            document.getElementById('locationData').innerHTML = html;
            
            lastPosition = position;
        }

        // Save to Firebase
        async function saveToFirebase(position) {
            try {
                const locationData = {
                    driverId: driverId,
                    isActive: true,
                    location: {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        speed: position.coords.speed || 0,
                        heading: position.coords.heading || 0
                    },
                    lastUpdate: serverTimestamp()
                };

                await setDoc(doc(db, 'drivers', driverId), locationData, { merge: true });
                logToConsole('âœ“ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase', 'success');
            } catch (error) {
                logToConsole(`âœ— ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase: ${error.message}`, 'error');
            }
        }

        // Start tracking
        window.startTracking = function() {
            if (watchId !== null) {
                logToConsole('Ø§Ù„ØªØªØ¨Ø¹ Ù†Ø´Ø· Ø¨Ø§Ù„ÙØ¹Ù„!', 'warning');
                return;
            }

            logToConsole('Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹...', 'info');

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            watchId = navigator.geolocation.watchPosition(
                // Success callback
                (position) => {
                    updateCount++;
                    document.getElementById('updateCount').textContent = updateCount;
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ar-SA');
                    
                    logToConsole(`ØªØ­Ø¯ÙŠØ« #${updateCount} - Lat: ${position.coords.latitude.toFixed(6)}, Lng: ${position.coords.longitude.toFixed(6)}, Accuracy: ${position.coords.accuracy.toFixed(2)}m`, 'success');
                    
                    updateLocationDisplay(position);
                    saveToFirebase(position);
                },
                // Error callback
                (error) => {
                    let errorMsg = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø±ÙØ¶ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø·Ù„Ø¨';
                            break;
                        default:
                            errorMsg = 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    }
                    logToConsole(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØªØ¨Ø¹: ${errorMsg} (${error.message})`, 'error');
                },
                options
            );

            // Update UI
            document.getElementById('trackingStatus').textContent = 'âœ“ Ù†Ø´Ø·';
            document.getElementById('trackingStatus').className = 'status-value success';
            document.getElementById('watchIdBadge').textContent = `Watch ID: ${watchId}`;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            logToConsole(`âœ“ Ø§Ù„ØªØªØ¨Ø¹ Ø¨Ø¯Ø£ Ø¨Ù†Ø¬Ø§Ø­ (Watch ID: ${watchId})`, 'success');
        };

        // Stop tracking
        window.stopTracking = function() {
            if (watchId === null) {
                logToConsole('Ø§Ù„ØªØªØ¨Ø¹ ØºÙŠØ± Ù†Ø´Ø·!', 'warning');
                return;
            }

            navigator.geolocation.clearWatch(watchId);
            logToConsole(`âœ“ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹ (Watch ID: ${watchId})`, 'success');
            
            watchId = null;

            // Update UI
            document.getElementById('trackingStatus').textContent = 'â—‹ ØºÙŠØ± Ù†Ø´Ø·';
            document.getElementById('trackingStatus').className = 'status-value warning';
            document.getElementById('watchIdBadge').textContent = 'Watch ID: ØºÙŠØ± Ù†Ø´Ø·';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;

            // Update Firebase
            setDoc(doc(db, 'drivers', driverId), {
                isActive: false,
                lastUpdate: serverTimestamp()
            }, { merge: true }).catch(error => {
                logToConsole(`ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Firebase: ${error.message}`, 'error');
            });
        };

        // Get current position (one-time)
        window.getCurrentPosition = function() {
            logToConsole('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ...', 'info');

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    logToConsole(`âœ“ ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ - Lat: ${position.coords.latitude.toFixed(6)}, Lng: ${position.coords.longitude.toFixed(6)}, Accuracy: ${position.coords.accuracy.toFixed(2)}m`, 'success');
                    updateLocationDisplay(position);
                },
                (error) => {
                    let errorMsg = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø±ÙØ¶ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø·Ù„Ø¨';
                            break;
                        default:
                            errorMsg = 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    }
                    logToConsole(`Ø®Ø·Ø£: ${errorMsg} (${error.message})`, 'error');
                },
                options
            );
        };

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            logToConsole('Ø§Ù„ØµÙØ­Ø© ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§', 'info');
            checkBrowserAndPermissions();
        });
    </script>
</body>
</html>

