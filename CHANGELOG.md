# CHANGELOG

## [2025-10-11] - إصلاح إنشاء حسابات المستخدمين التلقائي للسائقين

### المشكلة:
عند إضافة سائق جديد من صفحة إدارة السائقين:
- ✅ كان يتم إنشاء سجل السائق في مجموعة `drivers`
- ❌ **لم يتم إنشاء حساب مستخدم تلقائياً في مجموعة `users`**
- ❌ السائق لم يستطع تسجيل الدخول إلى النظام

### السبب:
1. وجود خطأ نصي في الكود (نص عربي غير مكتمل)
2. استخدام `setDoc` مع معرف يدوي بدلاً من `addDoc`
3. كلمة المرور كانت `123456` بدلاً من `123`
4. عدم وجود معالجة صحيحة للأخطاء

### الحل:
تم تحديث الكود في `drivers.html` ليقوم بـ:

```javascript
// إضافة سائق جديد
const driverDoc = await addDoc(collection(db, 'drivers'), driverData);
console.log('✅ تم إنشاء السائق في drivers:', driverDoc.id);

// إنشاء حساب تلقائي في مجموعة users
try {
    const userData = {
        name: driverData.name,
        email: '',
        password: '123',
        role: 'driver',
        isActive: true,
        driverId: driverDoc.id,
        createdAt: new Date(),
        createdBy: currentUser.name || currentUser.email
    };
    
    const userDoc = await addDoc(collection(db, 'users'), userData);
    console.log('✅ تم إنشاء حساب في users:', userDoc.id);
    alert('تم إضافة السائق بنجاح وإنشاء حساب له في النظام');
} catch (userError) {
    console.error('❌ خطأ في إنشاء حساب المستخدم:', userError);
    alert('تم إضافة السائق لكن حدث خطأ في إنشاء حساب له. الخطأ: ' + userError.message);
}
```

### التغييرات المطبقة:
1. ✅ استخدام `addDoc` بدلاً من `setDoc` لإنشاء معرف تلقائي
2. ✅ تغيير كلمة المرور الافتراضية من `123456` إلى `123`
3. ✅ إصلاح الأخطاء النصية في الكود
4. ✅ تحسين معالجة الأخطاء والرسائل التوضيحية

### النتيجة:
✅ الآن عند إضافة سائق جديد:
- يتم إنشاء سجل في مجموعة `drivers`
- يتم إنشاء حساب مستخدم تلقائياً في مجموعة `users`
- يتم تعيين:
  - **اسم المستخدم**: نفس اسم السائق
  - **كلمة المرور**: `123`
  - **الدور**: `driver`
  - **الحالة**: نشط (`isActive: true`)
- السائق يستطيع تسجيل الدخول مباشرة من صفحة دخول السائقين

### الاختبارات المنجزة:
✅ تم إضافة سائق تجريبي بنجاح
✅ تم إنشاء حساب المستخدم تلقائياً
✅ تم تسجيل الدخول بنجاح باستخدام الحساب الجديد
✅ جميع البيانات تظهر بشكل صحيح في صفحة السائق

### الملفات المعدلة:
1. **drivers.html** - إصلاح وظيفة إنشاء حساب المستخدم التلقائي
2. **CHANGELOG.md** - توثيق الإصلاح

---

## [2025-10-10] - إصلاح التسجيل المضاعف لدفعات السائقين في الإيرادات

### المشكلة:
عند إضافة دفعة من صفحة السائق (أجرة يومية، دين قديم، تحصيل مخالفة، إلخ):
- ✅ كانت تُضاف إلى `driverPayments`
- ✅ كانت تُضاف إلى `revenues`
- ❌ **الرصيد البنكي وإجمالي الإيرادات يزيدان مرتين** (لأنهما يحسبان من كلا المصدرين)

### مثال:
- دفع سائق 100 د.ك "دين قديم"
- النتيجة:
  - إجمالي الديون: ينقص 100 د.ك ✅ (يحسب من driverPayments فقط)
  - الرصيد البنكي: يزيد 200 د.ك ❌ (يحسب من driverPayments + revenues)
  - إجمالي الإيرادات: يزيد 200 د.ك ❌ (يحسب من driverPayments + revenues)

### السبب:
الكود في `driver-payments.html` كان يضيف الدفعة إلى **كلا المصدرين**:
1. `driverPayments` (لتسجيل تاريخ مدفوعات السائق)
2. `revenues` (لحساب الإيرادات)

لكن الكود في `unified-balance.js` و `revenues.html` يحسب الإيرادات من **كلا المصدرين**، مما يؤدي إلى **تسجيل مضاعف**.

### الحل:
تم حذف الكود الذي يضيف إلى `revenues` من `driver-payments.html`. الآن:
- ✅ الدفعات تُضاف إلى `driverPayments` فقط
- ✅ الإيرادات تُحسب تلقائياً من `driverPayments`
- ✅ لا يوجد تسجيل مضاعف

### البنود المتأثرة:
- أجرة يومية
- دين قديم
- تحصيل مخالفة
- تحصيل رسوم إقامة
- تحصيل رسوم إيداعات الرواتب

### النتيجة:
✅ الآن عند دفع السائق 100 د.ك:
- إجمالي الديون: ينقص 100 د.ك ✅
- الرصيد البنكي: يزيد 100 د.ك ✅
- إجمالي الإيرادات: يزيد 100 د.ك ✅

### الملفات المعدلة:
- `driver-payments.html` - حذف الكود الذي يضيف إلى revenues

---

## [2025-10-10] - إصلاح حساب الديون القديمة وطرح المدفوعات

### المشكلة:
عند إضافة دفعة "دين قديم" من السائق:
- ✅ كانت تُضاف إلى جدول driverPayments
- ✅ كانت تُضاف إلى جدول revenues (بعد الإصلاح السابق)
- ❌ **لم تُخصم من "الديون القديمة" في جدول السائقين**
- ❌ **لم تنقص من إجمالي الديون**

### السبب:
كانت دالة `calculateDriverDebt` في unified-balance.js و drivers-overview.html تأخذ قيمة `driver.oldDebts` مباشرة **بدون طرح** مدفوعات "دين قديم".

### الحل:
تم تحديث الدالتين لحساب الديون القديمة بالشكل الصحيح:
```javascript
const oldDebtsInitial = parseFloat(driver.oldDebts || 0);
const oldDebtPayments = payments.filter(p => p.type === 'دين قديم');
const oldDebtsPaid = oldDebtPayments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
const oldDebts = Math.max(0, oldDebtsInitial - oldDebtsPaid);
```

### النتيجة:
✅ الآن عند دفع السائق "دين قديم":
- تُخصم من عمود "ديون قديمة" في جدول السائقين
- تنقص من إجمالي الديون بشكل صحيح
- تُضاف إلى الإيرادات

### الملفات المعدلة:
1. **unified-balance.js** - إصلاح حساب الديون القديمة
2. **drivers-overview.html** - إصلاح حساب الديون القديمة
3. **CHANGELOG.md** - توثيق الإصلاح

---

**تاريخ آخر تحديث:** 11 أكتوبر 2025
**الإصدار:** 2.2 - إصلاح إنشاء حسابات المستخدمين
**المطور:** Manus AI Agent

