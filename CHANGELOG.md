# سجل التغييرات - نظا# سجل التغييرات

## [2025-10-11] - إصلاح إضافة المحاسب مع البريد الإلكتروني

### المشكلة:
في صفحة إدارة المستخدمين:
- ❌ **عند إضافة محاسب مع بريد إلكتروني، لا يتم قبول الإضافة**
- ✅ عند إضافة محاسب بدون بريد إلكتروني، يتم القبول

### السبب:
الكود كان يحاول إنشاء حساب في Firebase Authentication لأي مستخدم لديه بريد إلكتروني، بغض النظر عن الدور:

```javascript
if (email) {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    userId = userCredential.user.uid;
}
```

لكن **المحاسب والسائق لا يحتاجون Firebase Authentication**، فقط المدير يحتاجه.

### الحل:
تم تحديث الشرط في `user-management.html` ليكون:

```javascript
if (email && role === 'admin') {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    userId = userCredential.user.uid;
}
```

### النتيجة:
- ✅ **المدير**: يتم إنشاء حساب في Firebase Authentication (يحتاج إيميل)
- ✅ **المحاسب**: لا يتم إنشاء حساب في Firebase Authentication (يمكن إضافة إيميل أو لا)
- ✅ **السائق**: لا يتم إنشاء حساب في Firebase Authentication (بدون إيميل)

---

## [2025-10-11] - توحيد تنسيقات صفحة إدارة المستخدمين

### التحديثات:
1. **حذف التنسيقات الداخلية**: تم حذف قسم `<style>` من `user-management.html` (335 سطر)
2. **إضافة التنسيقات إلى style.css**: تم إضافة تنسيقات صفحة المستخدمين إلى `style.css` الموحد
3. **تحديث البانر**: تم تغيير `nav-button` إلى `nav-btn` لتطابق باقي الصفحات

### الفوائد:
- ✅ جميع الصفحات تستخدم `style.css` الموحد
- ✅ سهولة الصيانة والتعديل
- ✅ تناسق التنسيق بين جميع الصفحات
- ✅ تحميل أسرع للصفحات

---

## [2025-10-11] - إصلاح عرض الوصف التفصيلي للإيرادات

### المشكلة:
عند إضافة إيراد من نوع "أخرى" في صفحة الإيرادات:
- ❌ **الوصف التفصيلي لم يظهر الوصف المدخل من المستخدم**
- ❌ كان يظهر وصف تلقائي خاص بدفعات السائقين
- ❌ المشكلة ظهرت بعد إضافة نظام الصلاحيات

### السبب:
1. **خطأ في اسم المتغير**: تم تعريف `detailDescription` لكن تم استخدام `detailedDescription`
2. **استخدام `revenue.timestamp`**: بعض السجلات القديمة لا تحتوي على هذا الحقل
3. **الكود يعيد كتابة الوصف**: للإيرادات المباشرة بدلاً من استخدام الوصف المدخل

### الحل:
تم تحديث الكود في `revenues.html` (دالة `displayRevenues`):

```javascript
// توحيد اسم المتغير
let detailedDescription = revenue.description || '-';

// استخدام createdAt بدلاً من timestamp
deleteButton = getRevenueDeleteButton(revenue.id, revenue.date, revenue.createdAt, 'deleteRevenue', 'delete-btn');

// الوصف التفصيلي للدفعات من السائقين فقط
if (revenue.source === 'driverPayment') {
    // إنشاء وصف تلقائي مفصل
    detailedDescription = `${revenue.type} من السائق: ${driverName}`;
}
// للإيرادات المباشرة، استخدم الوصف المدخل من المستخدم
```

### النتيجة:
- ✅ الإيرادات من نوع "أخرى" تظهر الوصف المدخل من المستخدم
- ✅ دفعات السائقين تظهر الوصف التلقائي المفصل
- ✅ لا توجد أخطاء في السجلات القديمة
- ✅ نظام الصلاحيات يعمل بشكل صحيح

### الملفات المعدلة:
- `revenues.html`

---

## [2025-10-11] - إصلاح إنشاء حسابات المستخدمين التلقائي للسائقين

### المشكلة:
عند إضافة سائق جديد من صفحة إدارة السائقين:
- ✅ كان يتم إنشاء سجل السائق في مجموعة `drivers`
- ❌ **لم يتم إنشاء حساب مستخدم تلقائياً في مجموعة `users`**
- ❌ السائق لم يستطع تسجيل الدخول إلى النظام

### السبب:
1. وجود خطأ نصي في الكود (نص عربي غير مكتمل)
2. استخدام `setDoc` مع معرف يدوي بدلاً من `addDoc`
3. كلمة المرور كانت `123456` بدلاً من `123`
4. عدم وجود معالجة صحيحة للأخطاء

### الحل:
تم تحديث الكود في `drivers.html` ليقوم بـ:

```javascript
// إضافة سائق جديد
const driverDoc = await addDoc(collection(db, 'drivers'), driverData);
console.log('✅ تم إنشاء السائق في drivers:', driverDoc.id);

// إنشاء حساب تلقائي في مجموعة users
try {
    const userData = {
        name: driverData.name,
        email: '',
        password: '123',
        role: 'driver',
        isActive: true,
        driverId: driverDoc.id,
        createdAt: new Date(),
        createdBy: currentUser.name || currentUser.email
    };
    
    const userDoc = await addDoc(collection(db, 'users'), userData);
    console.log('✅ تم إنشاء حساب في users:', userDoc.id);
    alert('تم إضافة السائق بنجاح وإنشاء حساب له في النظام');
} catch (userError) {
    console.error('❌ خطأ في إنشاء حساب المستخدم:', userError);
    alert('تم إضافة السائق لكن حدث خطأ في إنشاء حساب له. الخطأ: ' + userError.message);
}
```

### التغييرات المطبقة:
1. ✅ استخدام `addDoc` بدلاً من `setDoc` لإنشاء معرف تلقائي
2. ✅ تغيير كلمة المرور الافتراضية من `123456` إلى `123`
3. ✅ إصلاح الأخطاء النصية في الكود
4. ✅ تحسين معالجة الأخطاء والرسائل التوضيحية

### النتيجة:
✅ الآن عند إضافة سائق جديد:
- يتم إنشاء سجل في مجموعة `drivers`
- يتم إنشاء حساب مستخدم تلقائياً في مجموعة `users`
- يتم تعيين:
  - **اسم المستخدم**: نفس اسم السائق
  - **كلمة المرور**: `123`
  - **الدور**: `driver`
  - **الحالة**: نشط (`isActive: true`)
- السائق يستطيع تسجيل الدخول مباشرة من صفحة دخول السائقين

### الاختبارات المنجزة:
✅ تم إضافة سائق تجريبي بنجاح
✅ تم إنشاء حساب المستخدم تلقائياً
✅ تم تسجيل الدخول بنجاح باستخدام الحساب الجديد
✅ جميع البيانات تظهر بشكل صحيح في صفحة السائق

### الملفات المعدلة:
1. **drivers.html** - إصلاح وظيفة إنشاء حساب المستخدم التلقائي
2. **CHANGELOG.md** - توثيق الإصلاح

---

## [2025-10-10] - إصلاح التسجيل المضاعف لدفعات السائقين في الإيرادات

### المشكلة:
عند إضافة دفعة من صفحة السائق (أجرة يومية، دين قديم، تحصيل مخالفة، إلخ):
- ✅ كانت تُضاف إلى `driverPayments`
- ✅ كانت تُضاف إلى `revenues`
- ❌ **الرصيد البنكي وإجمالي الإيرادات يزيدان مرتين** (لأنهما يحسبان من كلا المصدرين)

### مثال:
- دفع سائق 100 د.ك "دين قديم"
- النتيجة:
  - إجمالي الديون: ينقص 100 د.ك ✅ (يحسب من driverPayments فقط)
  - الرصيد البنكي: يزيد 200 د.ك ❌ (يحسب من driverPayments + revenues)
  - إجمالي الإيرادات: يزيد 200 د.ك ❌ (يحسب من driverPayments + revenues)

### السبب:
الكود في `driver-payments.html` كان يضيف الدفعة إلى **كلا المصدرين**:
1. `driverPayments` (لتسجيل تاريخ مدفوعات السائق)
2. `revenues` (لحساب الإيرادات)

لكن الكود في `unified-balance.js` و `revenues.html` يحسب الإيرادات من **كلا المصدرين**، مما يؤدي إلى **تسجيل مضاعف**.

### الحل:
تم حذف الكود الذي يضيف إلى `revenues` من `driver-payments.html`. الآن:
- ✅ الدفعات تُضاف إلى `driverPayments` فقط
- ✅ الإيرادات تُحسب تلقائياً من `driverPayments`
- ✅ لا يوجد تسجيل مضاعف

### البنود المتأثرة:
- أجرة يومية
- دين قديم
- تحصيل مخالفة
- تحصيل رسوم إقامة
- تحصيل رسوم إيداعات الرواتب

### النتيجة:
✅ الآن عند دفع السائق 100 د.ك:
- إجمالي الديون: ينقص 100 د.ك ✅
- الرصيد البنكي: يزيد 100 د.ك ✅
- إجمالي الإيرادات: يزيد 100 د.ك ✅

### الملفات المعدلة:
- `driver-payments.html` - حذف الكود الذي يضيف إلى revenues

---

## [2025-10-10] - إصلاح حساب الديون القديمة وطرح المدفوعات

### المشكلة:
عند إضافة دفعة "دين قديم" من السائق:
- ✅ كانت تُضاف إلى جدول driverPayments
- ✅ كانت تُضاف إلى جدول revenues (بعد الإصلاح السابق)
- ❌ **لم تُخصم من "الديون القديمة" في جدول السائقين**
- ❌ **لم تنقص من إجمالي الديون**

### السبب:
كانت دالة `calculateDriverDebt` في unified-balance.js و drivers-overview.html تأخذ قيمة `driver.oldDebts` مباشرة **بدون طرح** مدفوعات "دين قديم".

### الحل:
تم تحديث الدالتين لحساب الديون القديمة بالشكل الصحيح:
```javascript
const oldDebtsInitial = parseFloat(driver.oldDebts || 0);
const oldDebtPayments = payments.filter(p => p.type === 'دين قديم');
const oldDebtsPaid = oldDebtPayments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
const oldDebts = Math.max(0, oldDebtsInitial - oldDebtsPaid);
```

### النتيجة:
✅ الآن عند دفع السائق "دين قديم":
- تُخصم من عمود "ديون قديمة" في جدول السائقين
- تنقص من إجمالي الديون بشكل صحيح
- تُضاف إلى الإيرادات

### الملفات المعدلة:
1. **unified-balance.js** - إصلاح حساب الديون القديمة
2. **drivers-overview.html** - إصلاح حساب الديون القديمة
3. **CHANGELOG.md** - توثيق الإصلاح

---

**تاريخ آخر تحديث:** 11 أكتوبر 2025
**الإصدار:** 2.2 - إصلاح إنشاء حسابات المستخدمين
**المطور:** Manus AI Agent

