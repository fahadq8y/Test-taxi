# تقرير تطوير نظام أنواع العقود والأرشفة
## نظام إدارة سيارات الأجرة

**التاريخ:** 2025-01-13  
**الإصدار:** 2.0  
**المطور:** Manus AI Assistant

---

## 📋 ملخص تنفيذي

تم تطوير نظام شامل لإدارة أنواع عقود السائقين مع نظام أرشفة متقدم يحافظ على السجلات المالية. يتيح النظام التمييز بين العقود اليومية والشهرية مع إمكانية أرشفة البيانات القديمة عند تغيير نوع العقد.

---

## ✨ المميزات الجديدة

### 1. نظام أنواع العقود

#### أ. أنواع العقود المدعومة
- **عقد يومي (Daily Contract):** للسائقين الذين يدفعون أجرة يومية
- **عقد شهري (Monthly Contract):** للسائقين الذين يدفعون مبلغاً شهرياً ثابتاً

#### ب. واجهة المستخدم
- حقل اختيار نوع العقد في نموذج إضافة/تعديل السائق
- إظهار/إخفاء الحقول تلقائياً حسب نوع العقد المختار:
  - **عقد يومي:** يظهر حقل "الأجرة اليومية"
  - **عقد شهري:** يظهر حقل "المبلغ الشهري"
- عرض نوع العقد في بطاقة السائق مع أيقونة مميزة:
  - 📅 يومي
  - 📆 شهري

#### ج. التحقق من البيانات
- حقل نوع العقد مطلوب (required)
- التحقق من إدخال المبلغ المناسب حسب نوع العقد
- حفظ القيم الصحيحة فقط في قاعدة البيانات

---

### 2. نظام الأرشفة

#### أ. الأرشفة التلقائية
- **متى يتم الأرشفة؟**
  - عند تغيير نوع العقد من يومي إلى شهري
  - عند تغيير نوع العقد من شهري إلى يومي

- **ماذا يتم حفظه؟**
  - نسخة كاملة من جميع بيانات السائق القديمة
  - تاريخ ووقت الأرشفة
  - اسم المستخدم الذي قام بالتعديل
  - سبب الأرشفة (تغيير نوع العقد)

#### ب. صفحة أرشيف السائقين
تم إنشاء صفحة مخصصة (`archived-drivers.html`) تحتوي على:

1. **عرض السائقين المؤرشفين:**
   - قائمة بجميع السائقين المؤرشفين
   - ترتيب حسب تاريخ الأرشفة (الأحدث أولاً)
   - عرض معلومات الأرشفة (التاريخ، المستخدم، السبب)

2. **خاصية البحث:**
   - البحث بالاسم
   - البحث برقم الهاتف
   - البحث بسبب الأرشفة

3. **إدارة السائقين المؤرشفين:**
   - **زر استعادة السائق (♻️):**
     - نقل السائق من الأرشيف إلى القائمة النشطة
     - التحقق من عدم وجود تعارض (رقم هاتف مكرر)
     - تسجيل تاريخ الاستعادة
   
   - **زر الحذف النهائي (🗑️):**
     - حذف السائق نهائياً من النظام
     - رسالتي تأكيد للحماية من الحذف الخاطئ
     - لا يمكن استعادة البيانات بعد الحذف النهائي

4. **التصميم:**
   - بطاقات مميزة بإطار أحمر للسائقين المؤرشفين
   - إشعار تحذيري في أعلى الصفحة
   - تصميم متجاوب يعمل على جميع الأجهزة

#### ج. الوصول للأرشيف
- زر "📦 الأرشيف" في صفحة إدارة السائقين
- تصميم مميز بلون مختلف للتمييز

---

## 🗄️ هيكل قاعدة البيانات

### مجموعة drivers (السائقين النشطين)

```javascript
{
  // الحقول الموجودة سابقاً
  name: string,
  phone: string,
  nationality: string,
  address: string,
  assignedCar: string,
  contractDuration: number,
  contractStartDate: timestamp,
  contractEndDate: timestamp,
  oldDebts: number,
  notes: string,
  
  // الحقول الجديدة
  contractType: "daily" | "monthly",        // نوع العقد
  dailyRent: number,                        // الأجرة اليومية (للعقود اليومية)
  monthlyPayment: number,                   // المبلغ الشهري (للعقود الشهرية)
  isArchived: boolean,                      // حالة الأرشفة
  previousContractType: string,             // نوع العقد السابق (عند التغيير)
  
  // حقول التتبع
  createdAt: timestamp,
  createdBy: string,
  updatedAt: timestamp,
  updatedBy: string,
  restoredAt: timestamp,                    // تاريخ الاستعادة (إن وجد)
  restoredBy: string                        // المستخدم الذي استعاد السائق
}
```

### مجموعة archivedDrivers (السائقين المؤرشفين)

```javascript
{
  // جميع حقول السائق من مجموعة drivers
  // بالإضافة إلى:
  
  isArchived: true,                         // دائماً true
  archivedAt: timestamp,                    // تاريخ الأرشفة
  archivedBy: string,                       // المستخدم الذي قام بالأرشفة
  archiveReason: string                     // سبب الأرشفة
}
```

---

## 🔄 سير العمل (Workflow)

### 1. إضافة سائق جديد
```
1. المستخدم يفتح نموذج إضافة سائق
2. يختار نوع العقد (يومي/شهري)
3. يظهر الحقل المناسب تلقائياً
4. يدخل البيانات المطلوبة
5. يحفظ السائق في مجموعة drivers
6. يتم تعيين isArchived = false
```

### 2. تعديل نوع العقد (مع الأرشفة)
```
1. المستخدم يفتح سائق موجود للتعديل
2. يغير نوع العقد من يومي إلى شهري (أو العكس)
3. النظام يكتشف التغيير تلقائياً
4. يتم حفظ نسخة من البيانات القديمة في archivedDrivers
5. يتم تحديث بيانات السائق بالنوع الجديد
6. رسالة تأكيد: "تم تحديث السائق بنجاح وتم أرشفة البيانات القديمة"
```

### 3. استعادة سائق من الأرشيف
```
1. المستخدم يفتح صفحة الأرشيف
2. يختار سائق مؤرشف
3. ينقر على "استعادة السائق"
4. النظام يتحقق من عدم وجود تعارض
5. يتم نقل البيانات إلى مجموعة drivers
6. يتم حذف السائق من archivedDrivers
7. تسجيل تاريخ الاستعادة
```

### 4. الحذف النهائي
```
1. المستخدم يفتح صفحة الأرشيف
2. يختار سائق مؤرشف
3. ينقر على "حذف نهائي"
4. رسالة تأكيد أولى: تحذير من عدم إمكانية الاستعادة
5. رسالة تأكيد ثانية: تأكيد نهائي
6. يتم حذف السائق نهائياً من archivedDrivers
```

---

## 📝 الملفات المعدلة والجديدة

### 1. ملفات معدلة

#### `/home/ubuntu/Test-taxi/drivers.html`
**التعديلات:**
- إضافة حقل نوع العقد في النموذج
- إضافة حقل المبلغ الشهري
- دالة `toggleContractFields()` لإظهار/إخفاء الحقول
- تحديث دالة `displayDrivers()` لعرض نوع العقد
- تحديث دالة `openModal()` لتعبئة حقول نوع العقد
- تحديث دالة حفظ النموذج للتحقق من تغيير نوع العقد والأرشفة
- إضافة زر الأرشيف في قسم الأزرار

**عدد الأسطر المضافة:** ~150 سطر  
**عدد الأسطر المعدلة:** ~50 سطر

### 2. ملفات جديدة

#### `/home/ubuntu/Test-taxi/archived-drivers.html`
**الوصف:** صفحة كاملة لإدارة أرشيف السائقين  
**المميزات:**
- عرض السائقين المؤرشفين
- خاصية البحث
- استعادة السائقين
- الحذف النهائي
- تصميم متجاوب

**عدد الأسطر:** ~350 سطر

#### `/home/ubuntu/Test-taxi/test-contract-system.html`
**الوصف:** صفحة اختبار شاملة للنظام الجديد  
**المحتوى:**
- شرح المميزات
- خطوات الاختبار اليدوي
- حالة التنفيذ لكل ميزة
- روابط سريعة للصفحات

**عدد الأسطر:** ~350 سطر

---

## 🔒 الأمان والصلاحيات

### 1. التحقق من الصلاحيات
- يتطلب تسجيل الدخول للوصول لجميع الصفحات
- فقط المستخدمون بصلاحية `admin` أو `accountant` يمكنهم:
  - إضافة/تعديل السائقين
  - الوصول للأرشيف
  - استعادة السائقين
  - الحذف النهائي

### 2. التحقق من البيانات
- التحقق من عدم وجود سائق نشط بنفس رقم الهاتف عند الاستعادة
- رسائل تأكيد متعددة للعمليات الحساسة
- تسجيل جميع العمليات مع اسم المستخدم والتاريخ

### 3. حماية البيانات
- الحفاظ على جميع السجلات المالية في الأرشيف
- عدم السماح بالحذف النهائي إلا بعد تأكيدين
- تسجيل سبب الأرشفة لكل عملية

---

## 🧪 خطوات الاختبار

### اختبار 1: إضافة سائق بعقد يومي
1. افتح صفحة إدارة السائقين
2. انقر على "إضافة سائق جديد"
3. اختر "عقد يومي"
4. تأكد من ظهور حقل "الأجرة اليومية"
5. أدخل البيانات واحفظ
6. تحقق من عرض "📅 يومي" في البطاقة

**النتيجة المتوقعة:** ✅ يتم حفظ السائق بنجاح مع نوع العقد الصحيح

---

### اختبار 2: إضافة سائق بعقد شهري
1. افتح صفحة إدارة السائقين
2. انقر على "إضافة سائق جديد"
3. اختر "عقد شهري"
4. تأكد من ظهور حقل "المبلغ الشهري"
5. أدخل البيانات واحفظ
6. تحقق من عرض "📆 شهري" في البطاقة

**النتيجة المتوقعة:** ✅ يتم حفظ السائق بنجاح مع نوع العقد الصحيح

---

### اختبار 3: تغيير نوع العقد والأرشفة
1. افتح سائق موجود بعقد يومي
2. غير نوع العقد إلى شهري
3. أدخل المبلغ الشهري
4. احفظ التغييرات
5. تحقق من رسالة "تم أرشفة البيانات القديمة"
6. افتح صفحة الأرشيف
7. تحقق من وجود السائق مع السبب

**النتيجة المتوقعة:** ✅ يتم حفظ نسخة في الأرشيف مع السبب الصحيح

---

### اختبار 4: استعادة سائق من الأرشيف
1. افتح صفحة الأرشيف
2. اختر سائق مؤرشف
3. انقر على "♻️ استعادة السائق"
4. وافق على رسالة التأكيد
5. ارجع لصفحة السائقين
6. تحقق من وجود السائق في القائمة

**النتيجة المتوقعة:** ✅ يتم نقل السائق بنجاح إلى القائمة النشطة

---

### اختبار 5: الحذف النهائي
1. افتح صفحة الأرشيف
2. اختر سائق مؤرشف
3. انقر على "🗑️ حذف نهائي"
4. وافق على رسالتي التأكيد
5. تحقق من اختفاء السائق من الأرشيف

**النتيجة المتوقعة:** ✅ يتم حذف السائق نهائياً من النظام

---

### اختبار 6: منع الاستعادة المكررة
1. أضف سائق جديد برقم هاتف معين
2. حاول استعادة سائق مؤرشف بنفس رقم الهاتف
3. تحقق من ظهور رسالة تحذير

**النتيجة المتوقعة:** ✅ يمنع النظام الاستعادة ويظهر رسالة تحذير

---

## 🎨 التصميم والواجهة

### الألوان المستخدمة
- **نوع العقد اليومي:** 📅 أزرق (#667eea)
- **نوع العقد الشهري:** 📆 بنفسجي (#764ba2)
- **الأرشيف:** 📦 أحمر (#ff6b6b)
- **الاستعادة:** ♻️ أخضر (#4caf50)
- **الحذف:** 🗑️ أحمر غامق (#dc3545)

### الأيقونات
- 📅 عقد يومي
- 📆 عقد شهري
- 📦 أرشيف
- ♻️ استعادة
- 🗑️ حذف نهائي
- ⚠️ تحذير

---

## 📊 الإحصائيات

### حجم التطوير
- **ملفات معدلة:** 1
- **ملفات جديدة:** 2
- **أسطر كود مضافة:** ~850 سطر
- **دوال جديدة:** 5
- **مجموعات Firebase جديدة:** 1

### الوقت المقدر للتطوير
- **التخطيط والتصميم:** 30 دقيقة
- **التطوير:** 2 ساعة
- **الاختبار:** 30 دقيقة
- **التوثيق:** 30 دقيقة
- **الإجمالي:** ~3.5 ساعة

---

## 🚀 التحسينات المستقبلية المقترحة

### 1. تقارير متقدمة
- تقرير بعدد السائقين لكل نوع عقد
- تقرير بالسائقين المؤرشفين خلال فترة زمنية
- مقارنة الإيرادات بين العقود اليومية والشهرية

### 2. إشعارات تلقائية
- إشعار عند اقتراب انتهاء العقد الشهري
- إشعار عند تجاوز عدد معين من الأرشفات

### 3. تصدير البيانات
- تصدير قائمة السائقين المؤرشفين إلى Excel
- تصدير تقرير شامل بالتغييرات

### 4. سجل التغييرات
- صفحة تعرض جميع التغييرات في أنواع العقود
- تتبع تاريخ كل سائق عبر الزمن

---

## ⚠️ ملاحظات هامة

### 1. التوافق مع النظام القديم
- السائقون الموجودون قبل التحديث لن يكون لديهم نوع عقد
- سيظهر "غير محدد" حتى يتم تحديثهم
- يجب تحديث جميع السائقين الموجودين لتحديد نوع العقد

### 2. النسخ الاحتياطي
- يُنصح بعمل نسخة احتياطية من قاعدة البيانات قبل التشغيل
- الأرشفة تحفظ نسخة من البيانات تلقائياً

### 3. الصلاحيات
- تأكد من أن جميع المستخدمين لديهم الصلاحيات المناسبة
- فقط Admin و Accountant يمكنهم الوصول للأرشيف

---

## 📞 الدعم والمساعدة

### في حالة وجود مشاكل:
1. تحقق من اتصال الإنترنت
2. تحقق من صلاحيات المستخدم
3. افتح Console في المتصفح لرؤية الأخطاء
4. راجع هذا التقرير للتأكد من الخطوات

### الأخطاء الشائعة وحلولها:

**خطأ: "لا يمكن حفظ البيانات"**
- **السبب:** عدم اختيار نوع العقد
- **الحل:** تأكد من اختيار نوع العقد قبل الحفظ

**خطأ: "لا يمكن استعادة السائق"**
- **السبب:** يوجد سائق نشط بنفس رقم الهاتف
- **الحل:** غير رقم هاتف السائق النشط أو المؤرشف

**خطأ: "غير مصرح لك بالوصول"**
- **السبب:** صلاحيات المستخدم غير كافية
- **الحل:** تسجيل الدخول بحساب Admin أو Accountant

---

## ✅ قائمة التحقق النهائية

- [x] إضافة حقل نوع العقد
- [x] إضافة حقل المبلغ الشهري
- [x] دالة إظهار/إخفاء الحقول
- [x] عرض نوع العقد في البطاقة
- [x] الأرشفة التلقائية عند التغيير
- [x] إنشاء صفحة الأرشيف
- [x] وظيفة استعادة السائق
- [x] وظيفة الحذف النهائي
- [x] التحقق من التعارضات
- [x] رسائل التأكيد
- [x] تسجيل العمليات
- [x] التصميم المتجاوب
- [x] التوثيق الشامل
- [x] صفحة الاختبار

---

## 📄 الخلاصة

تم تطوير نظام شامل ومتكامل لإدارة أنواع عقود السائقين مع نظام أرشفة متقدم. النظام يحافظ على جميع السجلات المالية ويوفر واجهة سهلة الاستخدام لإدارة السائقين وأرشفتهم واستعادتهم.

جميع المميزات المطلوبة تم تنفيذها بنجاح وجاهزة للاستخدام.

---

**تم إعداد هذا التقرير بواسطة:** Manus AI Assistant  
**التاريخ:** 13 يناير 2025  
**الإصدار:** 2.0

