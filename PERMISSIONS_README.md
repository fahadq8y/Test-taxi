# نظام الصلاحيات - دليل التشغيل السريع

## 🎯 الهدف
تطبيق نظام صلاحيات يتحكم في عمليات الحذف بناءً على دور المستخدم والوقت المنقضي منذ إنشاء العنصر.

## 👥 الأدوار والصلاحيات

| الدور | صلاحيات الحذف | القيود الزمنية |
|------|---------------|----------------|
| **المدير (Admin)** | كاملة | لا توجد |
| **المحاسب (Accountant)** | محدودة | خلال 24 ساعة فقط |
| **السائق (Driver)** | لا توجد | غير قابل للتطبيق |

## 📁 الملفات الجديدة

### ملفات النظام الأساسي
- `user-permissions.js` - نظام الصلاحيات الرئيسي
- `revenues-permissions.js` - صلاحيات صفحة الإيرادات
- `expenses-permissions.js` - صلاحيات صفحة المصروفات
- `driver-payments-permissions.js` - صلاحيات صفحة دفعات السائقين

### ملفات الاختبار والتوثيق
- `test-permissions.html` - صفحة اختبار النظام
- `PERMISSIONS_DOCUMENTATION.md` - توثيق شامل
- `PERMISSIONS_README.md` - هذا الملف

## 📝 الملفات المعدلة

### الصفحات الرئيسية
1. **revenues.html**
   - إضافة ملفات الصلاحيات
   - تحديث دالة الحذف
   - إضافة حقل `createdAt`

2. **expenses.html**
   - إضافة ملفات الصلاحيات
   - تحديث دوال الحذف
   - إضافة حقل `createdAt`

3. **driver-payments.html**
   - إضافة ملفات الصلاحيات
   - تحديث دالة الحذف
   - حقل `createdAt` موجود مسبقاً

## 🚀 التشغيل

### 1. الاختبار
افتح `test-permissions.html` في المتصفح:
```
file:///home/ubuntu/Test-taxi/test-permissions.html
```

### 2. الخطوات
1. اختر دور المستخدم من القائمة
2. اضغط على "تشغيل الاختبارات"
3. راجع النتائج

## ⚙️ كيفية العمل

### عند تسجيل الدخول
```
المستخدم → Firebase Auth → جلب الدور → حفظ في localStorage
```

### عند محاولة الحذف
```
ضغط زر الحذف → التحقق من الصلاحيات → عرض رسالة أو تنفيذ الحذف
```

## 🔒 الأمان

⚠️ **مهم جداً**: النظام الحالي يعمل على جانب العميل فقط.

**يُنصح بشدة** بإضافة قواعد أمان Firebase:
1. افتح Firebase Console
2. انتقل إلى Firestore Database
3. افتح تبويب Rules
4. انسخ القواعد من `PERMISSIONS_DOCUMENTATION.md`
5. انشر القواعد

## 📊 البيانات المطلوبة

### مجموعة users في Firestore
```javascript
{
  name: "اسم المستخدم",
  email: "email@example.com",
  role: "admin" | "accountant" | "driver",
  isActive: true
}
```

### العناصر الجديدة
يجب أن تحتوي على حقل `createdAt`:
```javascript
{
  date: "2024-01-01",
  // ... باقي الحقول
  createdAt: firebase.firestore.FieldValue.serverTimestamp()
}
```

## 🐛 استكشاف الأخطاء

### المشكلة: أزرار الحذف لا تظهر
**الحل**: تحقق من:
- تسجيل الدخول بشكل صحيح
- وجود الدور في localStorage
- تحميل ملفات الصلاحيات بشكل صحيح

### المشكلة: رسالة خطأ عند الحذف
**الحل**: تحقق من:
- الدور الحالي
- تاريخ إنشاء العنصر
- console المتصفح للأخطاء

### المشكلة: العناصر القديمة لا تعمل
**الحل**: العناصر القديمة بدون `createdAt` تستخدم حقل `date` كبديل

## 📞 الدعم

للحصول على معلومات مفصلة، راجع:
- `PERMISSIONS_DOCUMENTATION.md` - توثيق كامل
- `test-permissions.html` - اختبار تفاعلي
- Console المتصفح - للأخطاء والتحذيرات

## ✅ قائمة التحقق

- [x] تطبيق نظام الصلاحيات الأساسي
- [x] دمج مع Firebase Authentication
- [x] تطبيق قيود الوقت (24 ساعة)
- [x] تحديث صفحة الإيرادات
- [x] تحديث صفحة المصروفات
- [x] تحديث صفحة دفعات السائقين
- [x] إنشاء صفحة اختبار
- [x] كتابة التوثيق الشامل
- [ ] تطبيق قواعد أمان Firebase (موصى به)

## 📅 الإصدار

- **الإصدار**: 1.0.0
- **التاريخ**: 2024-10-11
- **الحالة**: جاهز للاستخدام

---

**ملاحظة**: لا تنسَ تطبيق قواعد أمان Firebase لحماية البيانات على جانب الخادم!

