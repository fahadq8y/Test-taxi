<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ§ÙƒØ³ÙŠ</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        /* ========== Header ========== */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: white;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* ========== Container ========== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* ========== Driver Profile Card ========== */
        .driver-profile {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 30px;
            align-items: center;
        }
        
        .driver-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .driver-info {
            flex: 1;
        }
        
        .driver-name {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }
        
        .driver-id {
            font-size: 16px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .driver-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            color: #555;
        }
        
        .detail-item .icon {
            font-size: 18px;
        }
        
        .driver-status {
            text-align: center;
        }
        
        .status-badge {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .status-badge.online {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        .last-update {
            font-size: 14px;
            color: #666;
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .action-btn.primary {
            background: #667eea;
            color: white;
        }
        
        .action-btn.primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .action-btn.secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .action-btn.secondary:hover {
            background: #e0e0e0;
        }
        
        /* ========== Stats Grid ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 0 0 0 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }
        
        .stat-icon {
            font-size: 36px;
            margin-bottom: 12px;
            display: block;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            position: relative;
            z-index: 1;
        }
        
        .stat-card.success .stat-value {
            color: #28a745;
        }
        
        .stat-card.warning .stat-value {
            color: #ffc107;
        }
        
        .stat-card.danger .stat-value {
            color: #dc3545;
        }
        
        .stat-card.info .stat-value {
            color: #17a2b8;
        }
        
        /* ========== Filter Section ========== */
        .filter-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }
        
        .filter-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            color: #666;
        }
        
        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .filter-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }
        
        /* ========== Map Container ========== */
        .map-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }
        
        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .map-title {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .map-controls {
            display: flex;
            gap: 10px;
        }
        
        #map {
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        /* ========== Timeline ========== */
        .timeline-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }
        
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .timeline-title {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .timeline {
            position: relative;
            padding-right: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            right: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e0e0e0;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            padding-right: 50px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            right: 8px;
            top: 5px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            border: 3px solid #667eea;
            z-index: 1;
        }
        
        .timeline-item.moving::before {
            border-color: #28a745;
        }
        
        .timeline-item.stopped::before {
            border-color: #dc3545;
        }
        
        .timeline-item.warning::before {
            border-color: #ffc107;
        }
        
        .timeline-content {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .timeline-time {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .timeline-location {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .timeline-details {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #888;
        }
        
        .timeline-detail {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* ========== Loading ========== */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ========== Responsive ========== */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .driver-profile {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .driver-avatar {
                margin: 0 auto;
            }
            
            .driver-details {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            #map {
                height: 350px;
            }
            
            .timeline {
                padding-right: 20px;
            }
            
            .timeline-item {
                padding-right: 35px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>ğŸš• ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚</h1>
            <div class="header-actions">
                <a href="tracking.html" class="btn">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ø±ÙŠØ·Ø©</a>
            </div>
        </div>
    </div>
    
    <!-- Container -->
    <div class="container">
        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p style="margin-top: 15px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>
        
        <!-- Driver Profile Card -->
        <div id="driverProfile" class="driver-profile" style="display: none;">
            <div class="driver-avatar">
                ğŸš—
            </div>
            <div class="driver-info">
                <div class="driver-name" id="driverName">-</div>
                <div class="driver-id" id="driverIdDisplay">-</div>
                <div class="driver-details">
                    <div class="detail-item">
                        <span class="icon">ğŸ“±</span>
                        <span id="driverPhone">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="icon">ğŸš—</span>
                        <span id="driverCar">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="icon">ğŸŒ</span>
                        <span id="driverNationality">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="icon">ğŸ“</span>
                        <span id="driverAddress">-</span>
                    </div>
                </div>
                <div class="quick-actions">
                    <button class="action-btn primary" onclick="callDriver()">
                        ğŸ“ Ø§ØªØµØ§Ù„
                    </button>
                    <button class="action-btn secondary" onclick="sendMessage()">
                        ğŸ’¬ Ø±Ø³Ø§Ù„Ø©
                    </button>
                    <button class="action-btn secondary" onclick="viewFinancial()">
                        ğŸ’° Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©
                    </button>
                </div>
            </div>
            <div class="driver-status">
                <div class="status-badge online" id="statusBadge">
                    ğŸŸ¢ Ù†Ø´Ø· Ø§Ù„Ø¢Ù†
                </div>
                <div class="last-update" id="lastUpdate">
                    Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: -
                </div>
            </div>
        </div>
        
        <!-- Stats Grid -->
        <div id="statsGrid" class="stats-grid" style="display: none;">
            <div class="stat-card">
                <span class="stat-icon">ğŸ“</span>
                <div class="stat-label">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ÙŠÙˆÙ…</div>
                <div class="stat-value" id="statDistance">0 ÙƒÙ…</div>
            </div>
            <div class="stat-card">
                <span class="stat-icon">â±ï¸</span>
                <div class="stat-label">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</div>
                <div class="stat-value" id="statWorkHours">0:00</div>
            </div>
            <div class="stat-card success">
                <span class="stat-icon">ğŸš—</span>
                <div class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø±Ø¹Ø©</div>
                <div class="stat-value" id="statAvgSpeed">0 ÙƒÙ…/Ø³</div>
            </div>
            <div class="stat-card warning">
                <span class="stat-icon">âš¡</span>
                <div class="stat-label">Ø£Ø¹Ù„Ù‰ Ø³Ø±Ø¹Ø©</div>
                <div class="stat-value" id="statMaxSpeed">0 ÙƒÙ…/Ø³</div>
            </div>
            <div class="stat-card info">
                <span class="stat-icon">ğŸ…¿ï¸</span>
                <div class="stat-label">Ø§Ù„ØªÙˆÙ‚ÙØ§Øª</div>
                <div class="stat-value" id="statStops">0</div>
            </div>
            <div class="stat-card">
                <span class="stat-icon">â¸ï¸</span>
                <div class="stat-label">ÙˆÙ‚Øª Ø§Ù„ØªÙˆÙ‚Ù</div>
                <div class="stat-value" id="statStopTime">0 Ø¯</div>
            </div>
            <div class="stat-card danger">
                <span class="stat-icon">ğŸ”¥</span>
                <div class="stat-label">Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„ÙˆÙ‚ÙˆØ¯</div>
                <div class="stat-value" id="statFuel">0 Ù„ØªØ±</div>
            </div>
            <div class="stat-card success">
                <span class="stat-icon">ğŸ’°</span>
                <div class="stat-label">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</div>
                <div class="stat-value" id="statRevenue">0 Ø¯.Ùƒ</div>
            </div>
        </div>
        
        <!-- Filter Section -->
        <div id="filterSection" class="filter-section" style="display: none;">
            <div class="filter-title">ğŸ“… Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="today">Ø§Ù„ÙŠÙˆÙ…</button>
                <button class="filter-btn" data-filter="yesterday">Ø£Ù…Ø³</button>
                <button class="filter-btn" data-filter="week">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</button>
                <button class="filter-btn" data-filter="month">Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</button>
            </div>
        </div>
        
        <!-- Map Container -->
        <div id="mapContainer" class="map-container" style="display: none;">
            <div class="map-header">
                <div class="map-title">ğŸ—ºï¸ Ø§Ù„Ù…Ø³Ø§Ø±</div>
                <div class="map-controls">
                    <button class="action-btn secondary" onclick="centerMap()">
                        ğŸ“ Ù…Ø±ÙƒØ²
                    </button>
                </div>
            </div>
            <div id="map"></div>
        </div>
        
        <!-- Timeline -->
        <div id="timelineContainer" class="timeline-container" style="display: none;">
            <div class="timeline-header">
                <div class="timeline-title">ğŸ• Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ</div>
                <button class="action-btn secondary" onclick="exportTimeline()">
                    ğŸ“¥ ØªØµØ¯ÙŠØ± CSV
                </button>
            </div>
            <div id="timeline" class="timeline">
                <!-- Timeline items will be inserted here -->
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf-NY59a0aMEMjI",
            authDomain: "taxi-management-system-d8210.firebaseapp.com",
            projectId: "taxi-management-system-d8210",
            storageBucket: "taxi-management-system-d8210.firebasestorage.app",
            messagingSenderId: "1092068479156",
            appId: "1:1092068479156:web:d62f2d7b76a1d0902ab7b9"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Global variables
        let driverId = null;
        let driverData = null;
        let locationHistory = [];
        let map = null;
        let pathPolyline = null;
        let currentFilter = 'today';
        
        // Get driver ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        driverId = urlParams.get('id');
        
        if (!driverId) {
            alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¦Ù‚!');
            window.location.href = 'tracking.html';
        }
        
        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            await loadDriverData();
            await loadLocationHistory();
            initMap();
            setupFilterButtons();
            updateUI();
        });
        
        // Load driver data
        async function loadDriverData() {
            try {
                const driverDoc = await getDoc(doc(db, 'drivers', driverId));
                if (driverDoc.exists()) {
                    driverData = { id: driverDoc.id, ...driverDoc.data() };
                } else {
                    throw new Error('Ø§Ù„Ø³Ø§Ø¦Ù‚ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                }
            } catch (error) {
                console.error('Error loading driver:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚');
            }
        }
        
        // Load location history
        async function loadLocationHistory() {
            try {
                const dateRange = getDateRange();
                const q = query(
                    collection(db, 'locationHistory'),
                    where('driverId', '==', driverId),
                    where('timestamp', '>=', dateRange.start),
                    where('timestamp', '<=', dateRange.end),
                    orderBy('timestamp', 'desc')
                );
                
                const snapshot = await getDocs(q);
                locationHistory = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                console.log(`Loaded ${locationHistory.length} location records`);
            } catch (error) {
                console.error('Error loading location history:', error);
                locationHistory = [];
            }
        }
        
        // Get date range based on filter
        function getDateRange() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch(currentFilter) {
                case 'today':
                    return { start: today, end: new Date() };
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    return { start: yesterday, end: today };
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return { start: weekAgo, end: new Date() };
                case 'month':
                    const monthAgo = new Date(today);
                    monthAgo.setDate(monthAgo.getDate() - 30);
                    return { start: monthAgo, end: new Date() };
                default:
                    return { start: today, end: new Date() };
            }
        }
        
        // Initialize map
        function initMap() {
            // Leaflet will be initialized after data is loaded
        }
        
        // Setup filter buttons
        function setupFilterButtons() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => {
                btn.addEventListener('click', async () => {
                    // Remove active class from all buttons
                    filterButtons.forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    btn.classList.add('active');
                    // Update filter
                    currentFilter = btn.dataset.filter;
                    // Reload data
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('driverProfile').style.display = 'none';
                    document.getElementById('statsGrid').style.display = 'none';
                    document.getElementById('mapContainer').style.display = 'none';
                    document.getElementById('timelineContainer').style.display = 'none';
                    
                    await loadLocationHistory();
                    updateUI();
                });
            });
        }
        
        // Update UI
        function updateUI() {
            if (!driverData) return;
            
            // Hide loading
            document.getElementById('loading').style.display = 'none';
            
            // Show sections
            document.getElementById('driverProfile').style.display = 'grid';
            document.getElementById('statsGrid').style.display = 'grid';
            document.getElementById('filterSection').style.display = 'block';
            document.getElementById('mapContainer').style.display = 'block';
            document.getElementById('timelineContainer').style.display = 'block';
            
            // Update driver profile
            updateDriverProfile();
            
            // Update stats
            updateStats();
            
            // Update map
            updateMap();
            
            // Update timeline
            updateTimeline();
        }
        
        // Update driver profile
        function updateDriverProfile() {
            document.getElementById('driverName').textContent = driverData.name || '-';
            document.getElementById('driverIdDisplay').textContent = driverData.id || '-';
            document.getElementById('driverPhone').textContent = driverData.phone || '-';
            
            // Car info
            const carInfo = driverData.carId ? 
                `${driverData.carId} - ${driverData.carModel || 'ØªÙˆÙŠÙˆØªØ§'}` : '-';
            document.getElementById('driverCar').textContent = carInfo;
            
            document.getElementById('driverNationality').textContent = driverData.nationality || '-';
            document.getElementById('driverAddress').textContent = driverData.address || '-';
            
            // Status
            const lastLocation = locationHistory.length > 0 ? locationHistory[0] : null;
            if (lastLocation) {
                const lastTime = lastLocation.timestamp?.toDate() || new Date(0);
                const now = new Date();
                const timeDiff = now - lastTime;
                const isOnline = timeDiff < 300000; // 5 minutes
                
                const statusBadge = document.getElementById('statusBadge');
                const lastUpdate = document.getElementById('lastUpdate');
                
                if (isOnline) {
                    statusBadge.className = 'status-badge online';
                    statusBadge.textContent = 'ğŸŸ¢ Ù†Ø´Ø· Ø§Ù„Ø¢Ù†';
                } else {
                    statusBadge.className = 'status-badge offline';
                    statusBadge.textContent = 'ğŸ”´ ØºÙŠØ± Ù†Ø´Ø·';
                }
                
                const minutes = Math.floor(timeDiff / 60000);
                const hours = Math.floor(minutes / 60);
                
                if (hours > 0) {
                    lastUpdate.textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
                } else if (minutes > 0) {
                    lastUpdate.textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: Ù…Ù†Ø° ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
                } else {
                    lastUpdate.textContent = 'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: Ø§Ù„Ø¢Ù†';
                }
            } else {
                document.getElementById('statusBadge').className = 'status-badge offline';
                document.getElementById('statusBadge').textContent = 'ğŸ”´ ØºÙŠØ± Ù†Ø´Ø·';
                document.getElementById('lastUpdate').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª';
            }
        }
        
        // Update stats
        function updateStats() {
            if (locationHistory.length === 0) {
                document.getElementById('statDistance').textContent = '0 ÙƒÙ…';
                document.getElementById('statWorkHours').textContent = '0:00';
                document.getElementById('statAvgSpeed').textContent = '0 ÙƒÙ…/Ø³';
                document.getElementById('statMaxSpeed').textContent = '0 ÙƒÙ…/Ø³';
                document.getElementById('statStops').textContent = '0';
                document.getElementById('statStopTime').textContent = '0 Ø¯';
                document.getElementById('statFuel').textContent = '0 Ù„ØªØ±';
                document.getElementById('statRevenue').textContent = '0 Ø¯.Ùƒ';
                return;
            }
            
            // Calculate distance (simplified - sum of distances between points)
            let totalDistance = 0;
            for (let i = 1; i < locationHistory.length; i++) {
                const prev = locationHistory[i];
                const curr = locationHistory[i - 1];
                const dist = calculateDistance(
                    prev.latitude, prev.longitude,
                    curr.latitude, curr.longitude
                );
                totalDistance += dist;
            }
            
            // Calculate work hours
            const first = locationHistory[locationHistory.length - 1].timestamp?.toDate();
            const last = locationHistory[0].timestamp?.toDate();
            const workMs = last - first;
            const hours = Math.floor(workMs / 3600000);
            const minutes = Math.floor((workMs % 3600000) / 60000);
            
            // Calculate speeds
            const speeds = locationHistory.map(l => l.speed * 3.6).filter(s => s > 0);
            const avgSpeed = speeds.length > 0 ? 
                (speeds.reduce((a, b) => a + b, 0) / speeds.length) : 0;
            const maxSpeed = speeds.length > 0 ? Math.max(...speeds) : 0;
            
            // Calculate stops
            const stops = locationHistory.filter(l => l.speed < 0.5).length;
            
            // Estimate stop time (simplified)
            const stopTime = Math.floor(stops * 5); // Assume 5 minutes per stop
            
            // Estimate fuel consumption (simplified - 10L per 100km)
            const fuel = (totalDistance / 100) * 10;
            
            // Estimate revenue (simplified - 8 KD per day)
            const revenue = currentFilter === 'today' ? 8 : 
                          currentFilter === 'week' ? 56 :
                          currentFilter === 'month' ? 240 : 8;
            
            // Update UI
            document.getElementById('statDistance').textContent = `${totalDistance.toFixed(1)} ÙƒÙ…`;
            document.getElementById('statWorkHours').textContent = `${hours}:${minutes.toString().padStart(2, '0')}`;
            document.getElementById('statAvgSpeed').textContent = `${avgSpeed.toFixed(0)} ÙƒÙ…/Ø³`;
            document.getElementById('statMaxSpeed').textContent = `${maxSpeed.toFixed(0)} ÙƒÙ…/Ø³`;
            document.getElementById('statStops').textContent = stops;
            document.getElementById('statStopTime').textContent = `${stopTime} Ø¯`;
            document.getElementById('statFuel').textContent = `${fuel.toFixed(1)} Ù„ØªØ±`;
            document.getElementById('statRevenue').textContent = `${revenue} Ø¯.Ùƒ`;
        }
        
        // Calculate distance between two points (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Update map
        function updateMap() {
            // Initialize map if not already done
            if (!map) {
                map = L.map('map').setView([29.3759, 47.9774], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);
            }
            
            // Clear existing path
            if (pathPolyline) {
                map.removeLayer(pathPolyline);
            }
            
            if (locationHistory.length === 0) return;
            
            // Create path from location history
            const pathCoords = locationHistory.map(l => [l.latitude, l.longitude]).reverse();
            pathPolyline = L.polyline(pathCoords, {
                color: '#667eea',
                weight: 4,
                opacity: 0.7
            }).addTo(map);
            
            // Add markers for start and end
            const start = locationHistory[locationHistory.length - 1];
            const end = locationHistory[0];
            
            L.marker([start.latitude, start.longitude], {
                icon: L.divIcon({
                    html: 'ğŸ',
                    className: 'emoji-marker',
                    iconSize: [30, 30]
                })
            }).addTo(map).bindPopup('Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©');
            
            L.marker([end.latitude, end.longitude], {
                icon: L.divIcon({
                    html: 'ğŸš—',
                    className: 'emoji-marker',
                    iconSize: [30, 30]
                })
            }).addTo(map).bindPopup('Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ');
            
            // Fit map to path
            map.fitBounds(pathPolyline.getBounds(), { padding: [50, 50] });
        }
        
        // Update timeline
        function updateTimeline() {
            const timelineEl = document.getElementById('timeline');
            timelineEl.innerHTML = '';
            
            if (locationHistory.length === 0) {
                timelineEl.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</p>';
                return;
            }
            
            // Show only first 20 items
            const itemsToShow = locationHistory.slice(0, 20);
            
            itemsToShow.forEach((location, index) => {
                const time = location.timestamp?.toDate() || new Date();
                const speed = (location.speed * 3.6).toFixed(1);
                const isMoving = location.speed > 0.5;
                
                const itemClass = isMoving ? 'moving' : 'stopped';
                const statusIcon = isMoving ? 'ğŸš—' : 'ğŸ…¿ï¸';
                const statusText = isMoving ? 'Ù…ØªØ­Ø±Ùƒ' : 'Ù…ØªÙˆÙ‚Ù';
                
                const item = document.createElement('div');
                item.className = `timeline-item ${itemClass}`;
                item.innerHTML = `
                    <div class="timeline-content">
                        <div class="timeline-time">
                            ${statusIcon} ${time.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })} - ${statusText}
                        </div>
                        <div class="timeline-location">
                            ğŸ“ ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}
                        </div>
                        <div class="timeline-details">
                            <div class="timeline-detail">
                                ğŸš— ${speed} ÙƒÙ…/Ø³
                            </div>
                            ${location.accuracy ? `
                            <div class="timeline-detail">
                                ğŸ“¡ Ø§Ù„Ø¯Ù‚Ø©: ${location.accuracy.toFixed(1)} Ù…
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                timelineEl.appendChild(item);
            });
            
            if (locationHistory.length > 20) {
                const moreBtn = document.createElement('p');
                moreBtn.style.textAlign = 'center';
                moreBtn.style.color = '#666';
                moreBtn.style.marginTop = '20px';
                moreBtn.innerHTML = `Ø¹Ø±Ø¶ 20 Ù…Ù† ${locationHistory.length} Ø­Ø¯Ø«`;
                timelineEl.appendChild(moreBtn);
            }
        }
        
        // Quick action functions
        window.callDriver = function() {
            if (driverData && driverData.phone) {
                window.location.href = `tel:${driverData.phone}`;
            }
        };
        
        window.sendMessage = function() {
            if (driverData && driverData.phone) {
                window.location.href = `sms:${driverData.phone}`;
            }
        };
        
        window.viewFinancial = function() {
            window.location.href = `driver-view.html?id=${driverId}`;
        };
        
        window.centerMap = function() {
            if (map && pathPolyline) {
                map.fitBounds(pathPolyline.getBounds(), { padding: [50, 50] });
            }
        };
        
        window.exportTimeline = function() {
            if (locationHistory.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }
            
            // Create CSV content
            let csv = 'Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„ÙˆÙ‚Øª,Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶,Ø®Ø· Ø§Ù„Ø·ÙˆÙ„,Ø§Ù„Ø³Ø±Ø¹Ø© (ÙƒÙ…/Ø³),Ø§Ù„Ø¯Ù‚Ø© (Ù…)\n';
            
            locationHistory.forEach(location => {
                const time = location.timestamp?.toDate() || new Date();
                const date = time.toLocaleDateString('ar-SA');
                const timeStr = time.toLocaleTimeString('ar-SA');
                const speed = (location.speed * 3.6).toFixed(1);
                const accuracy = location.accuracy ? location.accuracy.toFixed(1) : '-';
                
                csv += `${date},${timeStr},${location.latitude},${location.longitude},${speed},${accuracy}\n`;
            });
            
            // Download CSV
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `timeline_${driverId}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        };
    </script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>

